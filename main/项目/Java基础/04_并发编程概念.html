<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>并发编程概念 | 山  海</title>
    <meta name="description" content="">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.032ce348.css" as="style"><link rel="preload" href="/assets/js/app.daf90e44.js" as="script"><link rel="preload" href="/assets/js/2.5c2f89f7.js" as="script"><link rel="preload" href="/assets/js/19.ccac1f50.js" as="script"><link rel="prefetch" href="/assets/js/10.060e2bf0.js"><link rel="prefetch" href="/assets/js/11.2c1e7667.js"><link rel="prefetch" href="/assets/js/12.e4112fb1.js"><link rel="prefetch" href="/assets/js/13.c48f2af3.js"><link rel="prefetch" href="/assets/js/14.4c74936a.js"><link rel="prefetch" href="/assets/js/15.dde0f892.js"><link rel="prefetch" href="/assets/js/16.04fdeec3.js"><link rel="prefetch" href="/assets/js/17.50a51165.js"><link rel="prefetch" href="/assets/js/18.8ae9a823.js"><link rel="prefetch" href="/assets/js/20.dc3b4da0.js"><link rel="prefetch" href="/assets/js/21.537f2917.js"><link rel="prefetch" href="/assets/js/22.fa0e5570.js"><link rel="prefetch" href="/assets/js/23.dbc6b9de.js"><link rel="prefetch" href="/assets/js/24.86da2a97.js"><link rel="prefetch" href="/assets/js/25.8db6665f.js"><link rel="prefetch" href="/assets/js/26.7ff0ce90.js"><link rel="prefetch" href="/assets/js/27.498e5d1f.js"><link rel="prefetch" href="/assets/js/28.c7a49776.js"><link rel="prefetch" href="/assets/js/29.3f057de0.js"><link rel="prefetch" href="/assets/js/3.b7af9e84.js"><link rel="prefetch" href="/assets/js/30.15140778.js"><link rel="prefetch" href="/assets/js/31.e91d7705.js"><link rel="prefetch" href="/assets/js/32.e8b9f267.js"><link rel="prefetch" href="/assets/js/33.9d40e450.js"><link rel="prefetch" href="/assets/js/34.7c76fee5.js"><link rel="prefetch" href="/assets/js/35.893bc59e.js"><link rel="prefetch" href="/assets/js/36.13ad14c2.js"><link rel="prefetch" href="/assets/js/37.7b7d3440.js"><link rel="prefetch" href="/assets/js/38.93ac778e.js"><link rel="prefetch" href="/assets/js/39.10b0f4fe.js"><link rel="prefetch" href="/assets/js/4.11dd4e91.js"><link rel="prefetch" href="/assets/js/40.464abc1f.js"><link rel="prefetch" href="/assets/js/41.29e1fdca.js"><link rel="prefetch" href="/assets/js/42.415177f1.js"><link rel="prefetch" href="/assets/js/43.422cbd1e.js"><link rel="prefetch" href="/assets/js/44.f9780e88.js"><link rel="prefetch" href="/assets/js/45.2731c44f.js"><link rel="prefetch" href="/assets/js/46.eb287d68.js"><link rel="prefetch" href="/assets/js/47.a3668e5f.js"><link rel="prefetch" href="/assets/js/48.892840a4.js"><link rel="prefetch" href="/assets/js/49.b7d6cbaf.js"><link rel="prefetch" href="/assets/js/5.e02fc35f.js"><link rel="prefetch" href="/assets/js/50.06cadfd1.js"><link rel="prefetch" href="/assets/js/51.40d31a4d.js"><link rel="prefetch" href="/assets/js/52.33a7f0cc.js"><link rel="prefetch" href="/assets/js/53.13a99099.js"><link rel="prefetch" href="/assets/js/54.d6a76531.js"><link rel="prefetch" href="/assets/js/55.d31ae64c.js"><link rel="prefetch" href="/assets/js/56.805fbd61.js"><link rel="prefetch" href="/assets/js/57.b457ef1b.js"><link rel="prefetch" href="/assets/js/58.372ee965.js"><link rel="prefetch" href="/assets/js/59.3ef115d3.js"><link rel="prefetch" href="/assets/js/6.41be9e56.js"><link rel="prefetch" href="/assets/js/60.87fd023f.js"><link rel="prefetch" href="/assets/js/61.86290fe0.js"><link rel="prefetch" href="/assets/js/62.5f84a20b.js"><link rel="prefetch" href="/assets/js/63.7baf0019.js"><link rel="prefetch" href="/assets/js/7.96ae93e8.js"><link rel="prefetch" href="/assets/js/8.30d5150e.js"><link rel="prefetch" href="/assets/js/9.04db00b8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.032ce348.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">山  海</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/main/项目/" class="nav-link">导航栏</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/main/项目/" class="nav-link">导航栏</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/main/项目/Java基础/00_SPI.html" class="sidebar-link">SPI</a></li><li><a href="/main/项目/Java基础/01_注解.html" class="sidebar-link">注解</a></li><li><a href="/main/项目/Java基础/02_线程池面试题.html" class="sidebar-link">线程池面试题</a></li><li><a href="/main/项目/Java基础/04_并发编程概念.html" class="active sidebar-link">并发编程概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/main/项目/Java基础/04_并发编程概念.html#原子性" class="sidebar-link">原子性</a></li><li class="sidebar-sub-header"><a href="/main/项目/Java基础/04_并发编程概念.html#可见性" class="sidebar-link">可见性</a></li><li class="sidebar-sub-header"><a href="/main/项目/Java基础/04_并发编程概念.html#有序性" class="sidebar-link">有序性</a></li><li class="sidebar-sub-header"><a href="/main/项目/Java基础/04_并发编程概念.html#happens-before" class="sidebar-link">Happens-Before</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="并发编程概念"><a href="#并发编程概念" class="header-anchor">#</a> 并发编程概念</h1> <p>  并发编程或者说如何写出线程安全的代码，是非常考验程序员的功底的。</p> <p>  并发编程有三座大山，<strong>原子性</strong>、<strong>可见性</strong>、<strong>有序性</strong>。</p> <h2 id="原子性"><a href="#原子性" class="header-anchor">#</a> 原子性</h2> <p>  原子性问题的根本原因是<strong>线程切换</strong>。处理器在执行机器指令时，可以在任意指令后发生线程切换，破坏了程序执行的原子性。</p> <p>  通过加互斥锁的方式就可以保证程序的原子性，比如<strong>synchronized关键字</strong>、<strong>ReentrantLock可重入锁</strong>。</p> <h2 id="可见性"><a href="#可见性" class="header-anchor">#</a> 可见性</h2> <p>  可见性问题的根本原子是处理器的<strong>高速缓存</strong>和为了提升处理器执行性能的一些策略，比如MESI协议、写缓冲器、无效队列等。</p> <p>  当程序修改共享变量时，处理器执行的结果会写入高速缓存，通过异步的方式同步到主内存。所以其他线程不能及时感知到共享变量的变化。</p> <p>  通过加互斥锁的方式或者更加轻量级的volatile关键字就可以保证程序的可见性。在写入一个变量后，强制刷回主内存。在读取一个变量前，先失效高速缓存，强制从主内存中读取。</p> <h2 id="有序性"><a href="#有序性" class="header-anchor">#</a> 有序性</h2> <p>  有序性问题的根本原因是<strong>指令重排序</strong>。指令重排序的方式是多种多样的，为了提升指令的性能和并发度。</p> <p>  指令重排序分为两类，一类是<strong>编译器的指令重排序</strong>，另一类是<strong>CPU的指令重排序</strong>（又细分为两种，指令级重排序，内存系统重排序）。</p> <p>  重排序的目的是提升程序性能，但无论如何重排序都要保证程序最终运行结果不变，最常见的就是不会对存在依赖关系的指令进行重排序。这也是<code>as if serial（近似有序）</code>规则的要求，这种规则保证了程序在单线程的情况下结果正确，但在并发编程情况下是有问题的。</p> <p>  上段提到的编译器不是将Java文件编译成Class字节码文件的过程，而是指JVM将字节码文件编译成机器指令过程。众所周知，Java是一门解释型和编译型的语言，通常情况下，JVM字节码默认是解释执行的，但是随着程序运行的时间越长，<strong>越来越多的热点代码会被JVM感知到进而被直接编译成机器指令以提高程序性能</strong>。</p> <p>  编译器的指令重排序和CPU的指令重排序的方式是各种各样的，无法举例子。而内存系统的重排序，也就是高速缓存和主内存短暂的数据不一致情况。</p> <p>  通过加轻量级的volatile关键字就可以保证程序的有序性，在程序执行时通过内存屏障来禁止指令重排序保证有序性。</p> <h2 id="happens-before"><a href="#happens-before" class="header-anchor">#</a> Happens-Before</h2> <p>  Java程序遵守<strong>Happens-Before原则</strong>。在大部分情况下，我们的程序是没有问题的。在涉及并发编程时，我们可以基于该原则来校验程序是否存在线程安全（可见性和有序性）问题。</p> <p>  Happens-Before原则要表达的含义是前一个操作的结果对后一个操作是可见性的，不论是否发生在同一个线程里。</p> <p>  规则一：<strong>程序的顺序性规则</strong>。指在一个线程内，按照程序顺序，前面的操作 <code>Happens-Before</code> 于后续的任意操作。</p> <p>  规则二：<strong>volatile变量规则</strong>。指对一个volatile变量的写操作 <code>Happens-Before</code> 于后续对这个volatile变量的读操作。</p> <p>  规则三：<strong>传递性规则</strong>。指如果 A操作 <code>Happens-Before</code> B操作，且 B操作 <code>Happens-Before</code> C操作，那么 A操作 <code>Happens-Before</code> C操作。</p> <p>  规则四：<strong>管程中的锁规则</strong>。指管程中的解锁操作 <code>Happens-Before</code> 于后续的加锁操作。</p> <p>  规则五：<strong>线程启动规则</strong>。子线程可以看到主线程启动子线程之前的所有操作。</p> <p>  规则六：<strong>线程终止规则</strong>。主线程等待子线程完成（join），主线程可以看到子线程的所有操作。</p> <p>  规则七：<strong>线程中断规则</strong>。对线程调用<code>interrupt()</code>方法 <code>Happends-Before</code> 线程检测到中断的操作。</p> <p>  规则八：<strong>对象规则</strong>。一个对象的初始化完成 <code>Happens-Before</code> 一个对象的<code>finalize</code>方法。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/main/项目/Java基础/02_线程池面试题.html" class="prev">线程池面试题</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.daf90e44.js" defer></script><script src="/assets/js/2.5c2f89f7.js" defer></script><script src="/assets/js/19.ccac1f50.js" defer></script>
  </body>
</html>
