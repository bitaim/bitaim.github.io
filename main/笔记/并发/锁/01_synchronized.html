<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>synchronized | 山  海</title>
    <meta name="description" content="">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.032ce348.css" as="style"><link rel="preload" href="/assets/js/app.132ddbf7.js" as="script"><link rel="preload" href="/assets/js/2.5c2f89f7.js" as="script"><link rel="preload" href="/assets/js/128.c81d68f9.js" as="script"><link rel="prefetch" href="/assets/js/10.0e53bce9.js"><link rel="prefetch" href="/assets/js/100.6ebbdd4f.js"><link rel="prefetch" href="/assets/js/101.465a8446.js"><link rel="prefetch" href="/assets/js/102.3e4485c8.js"><link rel="prefetch" href="/assets/js/103.b9aca84b.js"><link rel="prefetch" href="/assets/js/104.83e2125c.js"><link rel="prefetch" href="/assets/js/105.7722414c.js"><link rel="prefetch" href="/assets/js/106.c351687d.js"><link rel="prefetch" href="/assets/js/107.fa9bae79.js"><link rel="prefetch" href="/assets/js/108.5a17a170.js"><link rel="prefetch" href="/assets/js/109.23a9fdc4.js"><link rel="prefetch" href="/assets/js/11.924d2005.js"><link rel="prefetch" href="/assets/js/110.a95e4813.js"><link rel="prefetch" href="/assets/js/111.87293fb4.js"><link rel="prefetch" href="/assets/js/112.5a192052.js"><link rel="prefetch" href="/assets/js/113.aea18fa8.js"><link rel="prefetch" href="/assets/js/114.217fed2e.js"><link rel="prefetch" href="/assets/js/115.ec9ea823.js"><link rel="prefetch" href="/assets/js/116.7c935041.js"><link rel="prefetch" href="/assets/js/117.7051ab5d.js"><link rel="prefetch" href="/assets/js/118.7c248185.js"><link rel="prefetch" href="/assets/js/119.4521d1a6.js"><link rel="prefetch" href="/assets/js/12.8e426061.js"><link rel="prefetch" href="/assets/js/120.e129c4ce.js"><link rel="prefetch" href="/assets/js/121.8f8613fd.js"><link rel="prefetch" href="/assets/js/122.5a226edf.js"><link rel="prefetch" href="/assets/js/123.70c2e7ac.js"><link rel="prefetch" href="/assets/js/124.816c27e2.js"><link rel="prefetch" href="/assets/js/125.808eee8b.js"><link rel="prefetch" href="/assets/js/126.ad8ad6d0.js"><link rel="prefetch" href="/assets/js/127.0de99521.js"><link rel="prefetch" href="/assets/js/129.5c50d9ed.js"><link rel="prefetch" href="/assets/js/13.438078b4.js"><link rel="prefetch" href="/assets/js/130.4e2a0154.js"><link rel="prefetch" href="/assets/js/131.9297dfd6.js"><link rel="prefetch" href="/assets/js/132.f104fb6c.js"><link rel="prefetch" href="/assets/js/133.9dafb982.js"><link rel="prefetch" href="/assets/js/134.65484ddd.js"><link rel="prefetch" href="/assets/js/135.80f7f732.js"><link rel="prefetch" href="/assets/js/136.7ff538d3.js"><link rel="prefetch" href="/assets/js/137.6799273a.js"><link rel="prefetch" href="/assets/js/138.7ec0f371.js"><link rel="prefetch" href="/assets/js/139.75e909d6.js"><link rel="prefetch" href="/assets/js/14.c8888a94.js"><link rel="prefetch" href="/assets/js/140.b8c3932f.js"><link rel="prefetch" href="/assets/js/141.fe4623aa.js"><link rel="prefetch" href="/assets/js/142.ea8fdd79.js"><link rel="prefetch" href="/assets/js/143.f7dadd18.js"><link rel="prefetch" href="/assets/js/144.406f6645.js"><link rel="prefetch" href="/assets/js/145.07c7928f.js"><link rel="prefetch" href="/assets/js/146.d1d17b80.js"><link rel="prefetch" href="/assets/js/147.978eb34e.js"><link rel="prefetch" href="/assets/js/148.90fe445e.js"><link rel="prefetch" href="/assets/js/149.fed37972.js"><link rel="prefetch" href="/assets/js/15.e61179b0.js"><link rel="prefetch" href="/assets/js/150.5016dd45.js"><link rel="prefetch" href="/assets/js/151.5ecd4445.js"><link rel="prefetch" href="/assets/js/152.7bdd1a37.js"><link rel="prefetch" href="/assets/js/153.7fb72daf.js"><link rel="prefetch" href="/assets/js/154.641d5144.js"><link rel="prefetch" href="/assets/js/155.ce96a899.js"><link rel="prefetch" href="/assets/js/156.114b3ec1.js"><link rel="prefetch" href="/assets/js/157.381cd390.js"><link rel="prefetch" href="/assets/js/158.3f20083b.js"><link rel="prefetch" href="/assets/js/159.c8330a64.js"><link rel="prefetch" href="/assets/js/16.6278237b.js"><link rel="prefetch" href="/assets/js/160.97ae5e26.js"><link rel="prefetch" href="/assets/js/161.e6fb65d1.js"><link rel="prefetch" href="/assets/js/162.c41da870.js"><link rel="prefetch" href="/assets/js/163.a8fe6406.js"><link rel="prefetch" href="/assets/js/164.05ae7d96.js"><link rel="prefetch" href="/assets/js/165.9b13122c.js"><link rel="prefetch" href="/assets/js/166.522bff26.js"><link rel="prefetch" href="/assets/js/167.c990ffce.js"><link rel="prefetch" href="/assets/js/168.a9b90b42.js"><link rel="prefetch" href="/assets/js/169.45fefdd0.js"><link rel="prefetch" href="/assets/js/17.fbb8cc26.js"><link rel="prefetch" href="/assets/js/170.b001a6e2.js"><link rel="prefetch" href="/assets/js/171.4d0a131f.js"><link rel="prefetch" href="/assets/js/172.a8fcf5ee.js"><link rel="prefetch" href="/assets/js/173.9cb87116.js"><link rel="prefetch" href="/assets/js/174.2f9cc0ec.js"><link rel="prefetch" href="/assets/js/175.5a659117.js"><link rel="prefetch" href="/assets/js/176.fcf0aff4.js"><link rel="prefetch" href="/assets/js/177.50fc6167.js"><link rel="prefetch" href="/assets/js/178.fee25f22.js"><link rel="prefetch" href="/assets/js/179.853a6e53.js"><link rel="prefetch" href="/assets/js/18.c98b197e.js"><link rel="prefetch" href="/assets/js/180.4ad7d812.js"><link rel="prefetch" href="/assets/js/181.7292d4e8.js"><link rel="prefetch" href="/assets/js/182.06606085.js"><link rel="prefetch" href="/assets/js/183.4c6b6372.js"><link rel="prefetch" href="/assets/js/184.4851c62d.js"><link rel="prefetch" href="/assets/js/185.f0f059bd.js"><link rel="prefetch" href="/assets/js/186.642a3feb.js"><link rel="prefetch" href="/assets/js/187.acc0c0cd.js"><link rel="prefetch" href="/assets/js/188.8207ebe7.js"><link rel="prefetch" href="/assets/js/189.d1962896.js"><link rel="prefetch" href="/assets/js/19.0d55b57e.js"><link rel="prefetch" href="/assets/js/190.97cf8985.js"><link rel="prefetch" href="/assets/js/191.4127dde3.js"><link rel="prefetch" href="/assets/js/192.e3ac05e2.js"><link rel="prefetch" href="/assets/js/193.ec3499fb.js"><link rel="prefetch" href="/assets/js/194.0df296a1.js"><link rel="prefetch" href="/assets/js/20.1e112538.js"><link rel="prefetch" href="/assets/js/21.9c9c4453.js"><link rel="prefetch" href="/assets/js/22.5308710a.js"><link rel="prefetch" href="/assets/js/23.7b3d62e9.js"><link rel="prefetch" href="/assets/js/24.9d4ba8c5.js"><link rel="prefetch" href="/assets/js/25.4e2505d4.js"><link rel="prefetch" href="/assets/js/26.4bf8feed.js"><link rel="prefetch" href="/assets/js/27.5419d111.js"><link rel="prefetch" href="/assets/js/28.3390255e.js"><link rel="prefetch" href="/assets/js/29.2901b68d.js"><link rel="prefetch" href="/assets/js/3.2f8e8ebb.js"><link rel="prefetch" href="/assets/js/30.ca79da09.js"><link rel="prefetch" href="/assets/js/31.dc32b8cb.js"><link rel="prefetch" href="/assets/js/32.d086b22e.js"><link rel="prefetch" href="/assets/js/33.24491803.js"><link rel="prefetch" href="/assets/js/34.a1c2324b.js"><link rel="prefetch" href="/assets/js/35.36cdfa73.js"><link rel="prefetch" href="/assets/js/36.985fb65a.js"><link rel="prefetch" href="/assets/js/37.5b7d8c67.js"><link rel="prefetch" href="/assets/js/38.cb779f17.js"><link rel="prefetch" href="/assets/js/39.c741f1db.js"><link rel="prefetch" href="/assets/js/4.11dd4e91.js"><link rel="prefetch" href="/assets/js/40.aea4d1c5.js"><link rel="prefetch" href="/assets/js/41.34049013.js"><link rel="prefetch" href="/assets/js/42.66d14dd3.js"><link rel="prefetch" href="/assets/js/43.e9f48f11.js"><link rel="prefetch" href="/assets/js/44.1b1bbd10.js"><link rel="prefetch" href="/assets/js/45.25b2c483.js"><link rel="prefetch" href="/assets/js/46.fdca3222.js"><link rel="prefetch" href="/assets/js/47.07cc1a51.js"><link rel="prefetch" href="/assets/js/48.955bbd2e.js"><link rel="prefetch" href="/assets/js/49.87f6d00b.js"><link rel="prefetch" href="/assets/js/5.57c5d330.js"><link rel="prefetch" href="/assets/js/50.ae65645a.js"><link rel="prefetch" href="/assets/js/51.0b749571.js"><link rel="prefetch" href="/assets/js/52.e41fd777.js"><link rel="prefetch" href="/assets/js/53.ae90ff4e.js"><link rel="prefetch" href="/assets/js/54.bb1cfd7f.js"><link rel="prefetch" href="/assets/js/55.7d7c5e79.js"><link rel="prefetch" href="/assets/js/56.de83f645.js"><link rel="prefetch" href="/assets/js/57.1782bd4a.js"><link rel="prefetch" href="/assets/js/58.a98e9b3c.js"><link rel="prefetch" href="/assets/js/59.f9f51655.js"><link rel="prefetch" href="/assets/js/6.bc57a6b2.js"><link rel="prefetch" href="/assets/js/60.4af28c59.js"><link rel="prefetch" href="/assets/js/61.bf6eedfc.js"><link rel="prefetch" href="/assets/js/62.a18b99d5.js"><link rel="prefetch" href="/assets/js/63.0b9f5922.js"><link rel="prefetch" href="/assets/js/64.c20a03fd.js"><link rel="prefetch" href="/assets/js/65.e72667a8.js"><link rel="prefetch" href="/assets/js/66.1d4f1bea.js"><link rel="prefetch" href="/assets/js/67.5d7daae5.js"><link rel="prefetch" href="/assets/js/68.e4ba756c.js"><link rel="prefetch" href="/assets/js/69.25946c2f.js"><link rel="prefetch" href="/assets/js/7.4f86dc65.js"><link rel="prefetch" href="/assets/js/70.5caa10aa.js"><link rel="prefetch" href="/assets/js/71.72076007.js"><link rel="prefetch" href="/assets/js/72.94dc5db3.js"><link rel="prefetch" href="/assets/js/73.a67d741b.js"><link rel="prefetch" href="/assets/js/74.b30872cb.js"><link rel="prefetch" href="/assets/js/75.4151ec32.js"><link rel="prefetch" href="/assets/js/76.38d424e5.js"><link rel="prefetch" href="/assets/js/77.25909a93.js"><link rel="prefetch" href="/assets/js/78.d6afe05f.js"><link rel="prefetch" href="/assets/js/79.e8b6361f.js"><link rel="prefetch" href="/assets/js/8.523e678b.js"><link rel="prefetch" href="/assets/js/80.0258ea60.js"><link rel="prefetch" href="/assets/js/81.398362d3.js"><link rel="prefetch" href="/assets/js/82.8d8b1248.js"><link rel="prefetch" href="/assets/js/83.c4f544f2.js"><link rel="prefetch" href="/assets/js/84.99da8de5.js"><link rel="prefetch" href="/assets/js/85.92b066bd.js"><link rel="prefetch" href="/assets/js/86.3229406a.js"><link rel="prefetch" href="/assets/js/87.9771a660.js"><link rel="prefetch" href="/assets/js/88.0b175578.js"><link rel="prefetch" href="/assets/js/89.1f7dffd7.js"><link rel="prefetch" href="/assets/js/9.4f1eaad5.js"><link rel="prefetch" href="/assets/js/90.ef6f44f9.js"><link rel="prefetch" href="/assets/js/91.22da4225.js"><link rel="prefetch" href="/assets/js/92.192e872c.js"><link rel="prefetch" href="/assets/js/93.4f274e91.js"><link rel="prefetch" href="/assets/js/94.7297ec15.js"><link rel="prefetch" href="/assets/js/95.59278457.js"><link rel="prefetch" href="/assets/js/96.5ee2802b.js"><link rel="prefetch" href="/assets/js/97.279256e2.js"><link rel="prefetch" href="/assets/js/98.d36bef0a.js"><link rel="prefetch" href="/assets/js/99.4e279728.js">
    <link rel="stylesheet" href="/assets/css/0.styles.032ce348.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">山  海</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/main/笔记/" class="nav-link">笔记</a></div><div class="nav-item"><a href="/main/实战/" class="nav-link">实战</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/main/笔记/" class="nav-link">笔记</a></div><div class="nav-item"><a href="/main/实战/" class="nav-link">实战</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/main/笔记/并发/锁/01_synchronized.html" class="active sidebar-link">synchronized</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/main/笔记/并发/锁/01_synchronized.html#对象的内存布局" class="sidebar-link">对象的内存布局</a></li><li class="sidebar-sub-header"><a href="/main/笔记/并发/锁/01_synchronized.html#jdk6" class="sidebar-link">JDK6</a></li><li class="sidebar-sub-header"><a href="/main/笔记/并发/锁/01_synchronized.html#monitorenter" class="sidebar-link">monitorenter</a></li></ul></li><li><a href="/main/笔记/并发/锁/02_ReentrantLock.html" class="sidebar-link">ReentrantLock</a></li><li><a href="/main/笔记/并发/锁/03_ReentrantReadWriteLock.html" class="sidebar-link">ReentrantReadWriteLock</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="synchronized"><a href="#synchronized" class="header-anchor">#</a> synchronized</h1> <p><strong>1、synchronized与ReentrantLock的根本区别</strong>?</p> <p>  synchronized关键字是在JVM层面加锁。而ReentrantLock是在JDK层面加锁。</p> <p><strong>2、synchronized使用方法</strong></p> <p>  多个线程都能要得到某个共享资源，所以就划分了一个区域，操作共享资源的代码就在区域内。要想进入这个区域就必须持有锁，不然就无法进入，这个区域叫做<strong>临界区</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedTest</span> <span class="token punctuation">{</span>

    <span class="token comment">// 修饰普通方法，是对当前类的实例对象加锁</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">methodOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// 修饰静态方法，是对当前类对象加锁</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">methodTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodThree</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 修饰代码块时，需要指定加锁对象</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>3、观察字节码文件</strong></p> <p>  通过<code>javap -v SynchronizedTest.class</code>指令查看字节码文件。</p> <div class="language- extra-class"><pre class="language-text"><code>{
  public com.bitaim.java.study.lock.syn.SynchronizedTest();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V
         4: return
      LineNumberTable:
        line 3: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lcom/bitaim/java/study/lock/syn/SynchronizedTest;

  public synchronized void methodOne();
    descriptor: ()V
    flags: ACC_PUBLIC, ACC_SYNCHRONIZED
    Code:
      stack=0, locals=1, args_size=1
         0: return
      LineNumberTable:
        line 5: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       1     0  this   Lcom/bitaim/java/study/lock/syn/SynchronizedTest;

  public static synchronized void methodTwo();
    descriptor: ()V
    flags: ACC_PUBLIC, ACC_STATIC, ACC_SYNCHRONIZED
    Code:
      stack=0, locals=0, args_size=0
         0: return
      LineNumberTable:
        line 7: 0

  public void methodThree();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=2, locals=3, args_size=1
         0: aload_0
         1: dup
         2: astore_1
         3: monitorenter
         4: aload_1
         5: monitorexit
         6: goto          14
         9: astore_2
        10: aload_1
        11: monitorexit
        12: aload_2
        13: athrow
        14: return
}
</code></pre></div><p>  使用<code>synchronized</code>修饰方法时，在字节码文件上可以看到增加了<code>ACC_SYNCHRONIZED</code>访问修饰符。</p> <p>  使用<code>synchronized</code>修饰代码块时，在字节码文件上可以看到增加了<code>monitorenter</code>、<code>monitorexit</code>两条指令，分别对应着加锁和解锁命令。</p> <p><strong>4、ACC_SYNCHRONIZED是什么</strong>？</p> <p><code>ACC_SYNCHRONIZED</code>会隐式调用<code>monitorenter</code>、<code>monitorexit</code>两条指令，去争夺monitor对象。</p> <p><code>monitorenter</code>和<code>monitorexit</code>指令是通过CAS操作来加锁和释放锁的。</p> <p><strong>5、Monitor对象</strong></p> <p>  JVM为每个实例对象和类对象分配了一个Monitor对象。如果要对这个对象加锁，那么必须获取这个对象关联的Monitor对象的lock锁。</p> <p>  基本原理是Monitor对象中有一个计数器。如果一个线程要想获取Monitor对象的锁，查看计算器是否为0.如果为0，说明当前没有其他线程获取到锁，当前线程可以获取到锁，并将计数器加一。</p> <p>  并且Monitor中的锁是支持可重入锁的。</p> <h2 id="对象的内存布局"><a href="#对象的内存布局" class="header-anchor">#</a> 对象的内存布局</h2> <p>  实例对象被分配在堆内存，也就是主内存（内存条）上，内存上的数据都是通过0、1来存储的。那么CPU是如何知道0、1到底对应着什么类型的数据呢？这要从实例对象在内存中的布局说起。</p> <p><strong>1、引入相关依赖</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jol<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jol-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>2、测试类</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectLayout</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>3、输出结果</strong></p> <div class="language- extra-class"><pre class="language-text"><code>java.lang.Object object internals:
OFFSET  SIZE   TYPE DESCRIPTION    VALUE
  0     4      (object header)    05 00 00 00 (00000101 00000000 00000000 00000000) (5)
  4     4      (object header)    00 00 00 00 (00000000 00000000 00000000 00000000) (0)
  8     4      (object header)    e5 01 00 f8 (11100101 00000001 00000000 11111000) (-13243)
  12    4      (loss due to the next object alignment) // 由于对象补齐而丢失的4字节数据
Instance size: 16 bytes // 实例对象所占大小16字节
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total // 空间损失4字节
</code></pre></div><p><strong>4、对象的组成</strong></p> <p>  可以看到对象在内存中的布局，包含12字节的<code>object header</code>对象头信息。一个对象在内存中完整的组成包括，对象头、实例数据、数据对齐(padding)。实例数据就是定义在对象中的变量。当实例数据和对象头所占字节之和不足以被8整除时，就需要<strong>数据对齐来补充字节</strong>。</p> <p>  对象头包含两部分。一部分是<code>Mark Word</code>，占8字节。另一部分是<code>Klass Pointer</code>，占4字节。通过<code>Klass Pointer</code>指针，可以确定该段内存数据的类型。如果当前对象是数组对象，那么对象头还会包含<code>Array Length</code>，占4字节。</p> <p>  在32位JVM系统中，<code>Klass Pointer</code>指针占8字节。而在64位JVM系统中，默认开启了指针压缩，因此<code>Klass Pointer</code>指针占4字节。</p> <p>  通过<code>java -XX:+PrintCommandLineFlags -version</code>来验证开启指针压缩这一观点。</p> <div class="language- extra-class"><pre class="language-text"><code>-XX:InitialHeapSize=400559936 -XX:MaxHeapSize=6408958976 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC
java version &quot;1.8.0_161&quot;
Java(TM) SE Runtime Environment (build 1.8.0_161-b12)
Java HotSpot(TM) 64-Bit Server VM (build 25.161-b12, mixed mode)
</code></pre></div><p>  其中<code>-XX:+UseCompressedClassPointers</code>代表使用了<strong>类指针压缩</strong>。<code>-XX:+UseCompressedOops</code>代表使用了<strong>普通对象指针压缩</strong>。</p> <p><strong>5、看一个完整的对象布局</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token comment">// private long userId = 12L; // 基本数据类型long 占8byte</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token number">12L</span><span class="token punctuation">;</span>  <span class="token comment">// 包装类型存储的是对象的指针 占4byte</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>com.bitaim.study.thread.User object internals:
 OFFSET  SIZE               TYPE DESCRIPTION                               VALUE
      0     4                    (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)
      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4                    (object header)                           05 c1 00 f8 (00000101 11000001 00000000 11111000) (-134168315)
     12     4     java.lang.Long User.userId                               12
     16     4   java.lang.String User.name                                 (object)
     20     4                    (loss due to the next object alignment)
Instance size: 24 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
</code></pre></div><p>  对象头固定是12字节。由于<code>userId</code>是Long包装引用类型，因此占4字节，<code>name</code>是String引用类型，因此占4字节。对齐数据占4字节。总共24字节。</p> <p>  如果<code>userId</code>使用long类型，那么占8字节，也就不再需要对齐数据了，对象大小还是24字节。</p> <p><strong>6、Mark Word</strong></p> <p>  Mark Word中记录<strong>锁信息</strong>、<strong>分代年龄</strong>、<strong>hashcode值</strong>。如下图所示。</p> <img src="https://img-blog.csdnimg.cn/20190111091608949.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpdWR1bl9jb29s,size_16,color_FFFFFF,t_70" width="550px"> <p>  可以看到分代年龄占4位，这也是晋升老年代的对象的年龄不能超过15的原因。</p> <p><strong>7、锁升级</strong></p> <p>  JDK6对synchronized进行了大幅度的优化，性能也获取了提升。引入了<strong>偏向锁</strong>和<strong>轻量级锁</strong>的概念，减少了获取锁和释放锁的性能损耗，因为在JDK6之间，synchronized一直是一把重量级锁，每次加锁解锁都需要切换到内核态去争抢互斥量。</p> <p>  从JDK6开始锁的状态一共有4种，无锁、偏向锁、轻量级锁、重量级锁。<code>Mark Word</code>的最后3位代表着锁的不同状态。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectLayout</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassLayout</span> layout <span class="token operator">=</span> <span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 无锁</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 加锁</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 解锁</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>无锁:              00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
轻量级锁（加锁):   00000000 00000000 00000000 00000000 00000011 00101010 11111000 01011000   
无锁（解锁）：     00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001     
</code></pre></div><p>  其中偏向锁是默认开启的，但偏向锁启动需要一些时间。因此在这个案例中，新创建的对象是无锁状态，当有线程加锁时直接升级为轻量级锁，解锁后还原为无锁状态。</p> <p><strong>偏向锁</strong></p> <p>  通过<code>-XX:BiasedLockingStartupDelay=0</code>JVM启动参数来关闭偏向锁启动延迟，使新创建的对象的锁状态是偏向锁状态。再次执行代码，打印结果如下。</p> <div class="language- extra-class"><pre class="language-text"><code>偏向锁：          00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000101 
偏向锁（加锁）：  00000000 00000000 00000000 00000000 00000010 11000010 00101000 00000101   
偏向锁（解锁）：  00000000 00000000 00000000 00000000 00000010 11000010 00101000 00000101     
</code></pre></div><p>  偏向锁只适用于单线程的情况。新创建的对象是偏向锁状态，但是其<code>Thread Id</code>为0。当有线程尝试来加锁时，发现<code>Thread Id</code>为0，知道当前没有线程获取了锁，则尝试通过<code>CAS</code>来修改<code>Thread Id</code>，修改成功则代表加锁成功。解锁时，<code>Thread Id</code>并没有被清空。当同一个线程来加锁时，无需CAS修改直接比较即可。<code>Thread Id</code>在<code>Mark Word</code>中用54bit来记录。</p> <p>  偏向锁代表有很大概念的情况下只有一个线程来加锁，而锁消除是只有一个线程来加锁。</p> <p>  创建的对象，<code>MarkWord</code>中的锁记录要么是无锁，要么是偏向锁。要么是<code>无锁--CAS--&gt;轻量级锁</code>，要么是<code>偏向锁--CAS--&gt;偏向锁--CAS--&gt;轻量级锁</code>。</p> <p><strong>轻量级锁</strong></p> <p>  当有其他线程来加锁时，发现<code>Thread Id</code>已经存在，则偏向锁直接升级为轻量级锁。</p> <p>  加锁的线程在栈中创建<code>Lock Record</code>对象，存储锁的对象头中的<code>Mark Word</code>信息。锁的对象头中不在存储这些信息，而是存储一个<code>Lock Record</code>指针，指向加锁的线程。线程通过CAS修改<code>Mark Word</code>中的<code>Lock Record</code>指针到当前线程栈，修改成功则代表加锁成功，加锁失败的线程将尝试自旋（自旋消耗CPU的），自旋失败后膨胀为重量级锁。</p> <p>  当调用hashcode方法时，会将hashcode值记录到<code>Mark Word</code>中。hashcode()方法会<strong>导致对象直接撤销偏向锁，升级为轻量级锁</strong>。</p> <p><strong>重量级锁</strong></p> <p>  当成为重量级锁时，就会创建一个<code>ObjectMonitor</code>对象，该对象是通过C++实现的。锁的对象头中<code>Mark Word</code>就会指向该监视器锁对象。</p> <p><code>ObjectMonitor</code>对象其中有三个重要的变量。第一个是<code>_owner</code>指针，指向当前持有锁的线。第二个是<code>_count</code>计数器，代表加锁次数。第三个是<code>_entrylist</code>队列，需要加锁的线程会先进入这个队列等待获取机会尝试加锁，进入队列等待的线程是不消耗CPU的。第四个是<code>_waitset</code>队列，持有锁的线程调用<code>wait</code>方法时，该线程就会进入该队列，释放锁，然后等待被唤醒。</p> <p><code>_entrylist</code>队列中的线程竞争加锁，加锁成功的线程将<code>_owner</code>指针指向自己，并将<code>_count</code>计数器加一。加锁失败的线程就会被阻塞住。</p> <p>  竞争加锁依赖于底层操作系统的<code>Mutex Lock</code>互斥量来加锁的，涉及到用户态与内核态的切换，成本非常高。</p> <h4 id="锁消除"><a href="#锁消除" class="header-anchor">#</a> 锁消除</h4> <p>  锁消除是JIT编译器对<code>synchronized</code>做的优化。在编译时，JIT会通过内存逃逸技术，如果确定<code>synchronized</code>锁对象只会被一个线程加锁，那么在编译时就不会加入<code>monitorenter</code>和<code>monitorexit</code>指令了。</p> <h4 id="锁粗化"><a href="#锁粗化" class="header-anchor">#</a> 锁粗化</h4> <p>  JIT编译器如果发现有代码持续多次加锁和释放锁，会合并成一个锁，就是锁粗化。避免多次加锁和释放锁。</p> <h4 id="适应性锁（自旋锁）"><a href="#适应性锁（自旋锁）" class="header-anchor">#</a> 适应性锁（自旋锁）</h4> <p>  轻量级加锁失败时，也有一个自旋锁的概念，自适应是底层自动调节的，到底采用不采用自旋锁，自旋多少次。如果线程持有锁的时间很短，其他加锁失败的线程会被阻塞，那么就会发生上下文切换。线程很快就释放锁了，又会唤醒阻塞的线程，这样频繁的线程上下文切换会很消耗性能的。</p> <p>  对于这种持有锁时间很短的情况，是可以采取忙等的策略的。也就是一个线程没有竞争到锁，进入一个while循环等待，不会暂停发生线程上下文切换，找机会再次加锁。这样可以大幅度减少线程上下文的切换，而这种自旋等待获取锁的方式，就是所谓的自旋锁，不断地自旋尝试加锁。</p> <p><code>synchronized</code>涉及到JVM底层的知识。比如栈帧、LockRecord等是相当复杂的。</p> <h2 id="jdk6"><a href="#jdk6" class="header-anchor">#</a> JDK6</h2> <p>  在JDK6（不包含6）之前，synchronized只是重量级锁。因为会有线程的阻塞和唤醒，这个操作是借助操作系统的系统调用来实现的，常见的Linux下就是利用 pthread 的 mutex 来实现的。</p> <p>  而涉及到系统调用就会有上下文的切换，即内核态与用户态的切换，这种切换的开销还是挺大的。所以称为重量级锁。</p> <h2 id="monitorenter"><a href="#monitorenter" class="header-anchor">#</a> monitorenter</h2> <p>  执行<code>monitorenter</code>方法时，首先会判断是否开启了偏向锁，开启了走快速逻辑（<code>fast_enter</code>），没开启走慢速逻辑（<code>slow_enter</code>）。</p> <p>  慢速逻辑，首先通过 CAS 把 ObjectMonitor 中的 _owner 设置为当前线程，设置成功就表示获取锁成功。然后通过 recursions 的自增来表示重入。</p> <h4 id="原子性"><a href="#原子性" class="header-anchor">#</a> 原子性</h4> <p>  通过加锁和解锁，保证同一时间只有一个线程可以对一段代码进行操作。</p> <h4 id="可见性"><a href="#可见性" class="header-anchor">#</a> 可见性</h4> <p>  内存屏障可以分为<code>Load屏障</code>和<code>Store屏障</code>。</p> <p>  在<code>monitorenter</code>指令之后会被施加一个<code>Load屏障</code>，代码块中某些值如果被其他处理器修改了，那么就要从其他处理器的高速缓存（或者主内存）里加载到自己的高速缓存里来，确保看到的是最新的数据，这个过程叫做<code>refresh</code>操作。</p> <p>  在<code>monitorexit</code>指令之后会被施加一个<code>Store屏障</code>，代码块中被处理器执行的写操作全部刷新到高速缓存（或者主内存）里去，这个过程叫做<code>flush</code>操作。</p> <h4 id="有序性"><a href="#有序性" class="header-anchor">#</a> 有序性</h4> <p>  按照有序性来划分的话，还可以分为<code>Acquire屏障</code>和<code>Release屏障</code>。</p> <p>  在<code>monitorenter</code>指令之后，<code>Load屏障</code>之后，会加一个<code>Acquire屏障</code>，作用是禁止代码块中的读操作与代码块上外部的读写操作之间发生指令重排序。</p> <p>  在<code>monitorexit</code>指令之后，<code>Store屏障</code>之后，会加一个<code>Release屏障</code>，作用是禁止代码块中的写操作与代码块下外部的读写操作之间发生指令重排序。</p> <p>  通过<code>Acquire屏障</code>和<code>Release屏障</code>就可以让synchronized保证有序性，只有synchronized内部的指令可以重排序，但是绝对不会与外部的指令发生重排序。</p> <p>  不要对内存屏障太较真了，没有一个官方权威的说法。了解一下吧。<code>Load屏障</code>、<code>Store屏障</code>还好理解，对于<code>Acquire屏障</code>、<code>Release屏障</code>就不太明白了。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">4/17/2021, 4:03:54 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/main/笔记/并发/锁/02_ReentrantLock.html">ReentrantLock</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.132ddbf7.js" defer></script><script src="/assets/js/2.5c2f89f7.js" defer></script><script src="/assets/js/128.c81d68f9.js" defer></script>
  </body>
</html>
