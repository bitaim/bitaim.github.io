<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分布式事务 | 山  海</title>
    <meta name="description" content="">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.032ce348.css" as="style"><link rel="preload" href="/assets/js/app.132ddbf7.js" as="script"><link rel="preload" href="/assets/js/2.5c2f89f7.js" as="script"><link rel="preload" href="/assets/js/96.5ee2802b.js" as="script"><link rel="prefetch" href="/assets/js/10.0e53bce9.js"><link rel="prefetch" href="/assets/js/100.6ebbdd4f.js"><link rel="prefetch" href="/assets/js/101.465a8446.js"><link rel="prefetch" href="/assets/js/102.3e4485c8.js"><link rel="prefetch" href="/assets/js/103.b9aca84b.js"><link rel="prefetch" href="/assets/js/104.83e2125c.js"><link rel="prefetch" href="/assets/js/105.7722414c.js"><link rel="prefetch" href="/assets/js/106.c351687d.js"><link rel="prefetch" href="/assets/js/107.fa9bae79.js"><link rel="prefetch" href="/assets/js/108.5a17a170.js"><link rel="prefetch" href="/assets/js/109.23a9fdc4.js"><link rel="prefetch" href="/assets/js/11.924d2005.js"><link rel="prefetch" href="/assets/js/110.a95e4813.js"><link rel="prefetch" href="/assets/js/111.87293fb4.js"><link rel="prefetch" href="/assets/js/112.5a192052.js"><link rel="prefetch" href="/assets/js/113.aea18fa8.js"><link rel="prefetch" href="/assets/js/114.217fed2e.js"><link rel="prefetch" href="/assets/js/115.ec9ea823.js"><link rel="prefetch" href="/assets/js/116.7c935041.js"><link rel="prefetch" href="/assets/js/117.7051ab5d.js"><link rel="prefetch" href="/assets/js/118.7c248185.js"><link rel="prefetch" href="/assets/js/119.4521d1a6.js"><link rel="prefetch" href="/assets/js/12.8e426061.js"><link rel="prefetch" href="/assets/js/120.e129c4ce.js"><link rel="prefetch" href="/assets/js/121.8f8613fd.js"><link rel="prefetch" href="/assets/js/122.5a226edf.js"><link rel="prefetch" href="/assets/js/123.70c2e7ac.js"><link rel="prefetch" href="/assets/js/124.816c27e2.js"><link rel="prefetch" href="/assets/js/125.808eee8b.js"><link rel="prefetch" href="/assets/js/126.ad8ad6d0.js"><link rel="prefetch" href="/assets/js/127.0de99521.js"><link rel="prefetch" href="/assets/js/128.c81d68f9.js"><link rel="prefetch" href="/assets/js/129.5c50d9ed.js"><link rel="prefetch" href="/assets/js/13.438078b4.js"><link rel="prefetch" href="/assets/js/130.4e2a0154.js"><link rel="prefetch" href="/assets/js/131.9297dfd6.js"><link rel="prefetch" href="/assets/js/132.f104fb6c.js"><link rel="prefetch" href="/assets/js/133.9dafb982.js"><link rel="prefetch" href="/assets/js/134.65484ddd.js"><link rel="prefetch" href="/assets/js/135.80f7f732.js"><link rel="prefetch" href="/assets/js/136.7ff538d3.js"><link rel="prefetch" href="/assets/js/137.6799273a.js"><link rel="prefetch" href="/assets/js/138.7ec0f371.js"><link rel="prefetch" href="/assets/js/139.75e909d6.js"><link rel="prefetch" href="/assets/js/14.c8888a94.js"><link rel="prefetch" href="/assets/js/140.b8c3932f.js"><link rel="prefetch" href="/assets/js/141.fe4623aa.js"><link rel="prefetch" href="/assets/js/142.ea8fdd79.js"><link rel="prefetch" href="/assets/js/143.f7dadd18.js"><link rel="prefetch" href="/assets/js/144.406f6645.js"><link rel="prefetch" href="/assets/js/145.07c7928f.js"><link rel="prefetch" href="/assets/js/146.d1d17b80.js"><link rel="prefetch" href="/assets/js/147.978eb34e.js"><link rel="prefetch" href="/assets/js/148.90fe445e.js"><link rel="prefetch" href="/assets/js/149.fed37972.js"><link rel="prefetch" href="/assets/js/15.e61179b0.js"><link rel="prefetch" href="/assets/js/150.5016dd45.js"><link rel="prefetch" href="/assets/js/151.5ecd4445.js"><link rel="prefetch" href="/assets/js/152.7bdd1a37.js"><link rel="prefetch" href="/assets/js/153.7fb72daf.js"><link rel="prefetch" href="/assets/js/154.641d5144.js"><link rel="prefetch" href="/assets/js/155.ce96a899.js"><link rel="prefetch" href="/assets/js/156.114b3ec1.js"><link rel="prefetch" href="/assets/js/157.381cd390.js"><link rel="prefetch" href="/assets/js/158.3f20083b.js"><link rel="prefetch" href="/assets/js/159.c8330a64.js"><link rel="prefetch" href="/assets/js/16.6278237b.js"><link rel="prefetch" href="/assets/js/160.97ae5e26.js"><link rel="prefetch" href="/assets/js/161.e6fb65d1.js"><link rel="prefetch" href="/assets/js/162.c41da870.js"><link rel="prefetch" href="/assets/js/163.a8fe6406.js"><link rel="prefetch" href="/assets/js/164.05ae7d96.js"><link rel="prefetch" href="/assets/js/165.9b13122c.js"><link rel="prefetch" href="/assets/js/166.522bff26.js"><link rel="prefetch" href="/assets/js/167.c990ffce.js"><link rel="prefetch" href="/assets/js/168.a9b90b42.js"><link rel="prefetch" href="/assets/js/169.45fefdd0.js"><link rel="prefetch" href="/assets/js/17.fbb8cc26.js"><link rel="prefetch" href="/assets/js/170.b001a6e2.js"><link rel="prefetch" href="/assets/js/171.4d0a131f.js"><link rel="prefetch" href="/assets/js/172.a8fcf5ee.js"><link rel="prefetch" href="/assets/js/173.9cb87116.js"><link rel="prefetch" href="/assets/js/174.2f9cc0ec.js"><link rel="prefetch" href="/assets/js/175.5a659117.js"><link rel="prefetch" href="/assets/js/176.fcf0aff4.js"><link rel="prefetch" href="/assets/js/177.50fc6167.js"><link rel="prefetch" href="/assets/js/178.fee25f22.js"><link rel="prefetch" href="/assets/js/179.853a6e53.js"><link rel="prefetch" href="/assets/js/18.c98b197e.js"><link rel="prefetch" href="/assets/js/180.4ad7d812.js"><link rel="prefetch" href="/assets/js/181.7292d4e8.js"><link rel="prefetch" href="/assets/js/182.06606085.js"><link rel="prefetch" href="/assets/js/183.4c6b6372.js"><link rel="prefetch" href="/assets/js/184.4851c62d.js"><link rel="prefetch" href="/assets/js/185.f0f059bd.js"><link rel="prefetch" href="/assets/js/186.642a3feb.js"><link rel="prefetch" href="/assets/js/187.acc0c0cd.js"><link rel="prefetch" href="/assets/js/188.8207ebe7.js"><link rel="prefetch" href="/assets/js/189.d1962896.js"><link rel="prefetch" href="/assets/js/19.0d55b57e.js"><link rel="prefetch" href="/assets/js/190.97cf8985.js"><link rel="prefetch" href="/assets/js/191.4127dde3.js"><link rel="prefetch" href="/assets/js/192.e3ac05e2.js"><link rel="prefetch" href="/assets/js/193.ec3499fb.js"><link rel="prefetch" href="/assets/js/194.0df296a1.js"><link rel="prefetch" href="/assets/js/20.1e112538.js"><link rel="prefetch" href="/assets/js/21.9c9c4453.js"><link rel="prefetch" href="/assets/js/22.5308710a.js"><link rel="prefetch" href="/assets/js/23.7b3d62e9.js"><link rel="prefetch" href="/assets/js/24.9d4ba8c5.js"><link rel="prefetch" href="/assets/js/25.4e2505d4.js"><link rel="prefetch" href="/assets/js/26.4bf8feed.js"><link rel="prefetch" href="/assets/js/27.5419d111.js"><link rel="prefetch" href="/assets/js/28.3390255e.js"><link rel="prefetch" href="/assets/js/29.2901b68d.js"><link rel="prefetch" href="/assets/js/3.2f8e8ebb.js"><link rel="prefetch" href="/assets/js/30.ca79da09.js"><link rel="prefetch" href="/assets/js/31.dc32b8cb.js"><link rel="prefetch" href="/assets/js/32.d086b22e.js"><link rel="prefetch" href="/assets/js/33.24491803.js"><link rel="prefetch" href="/assets/js/34.a1c2324b.js"><link rel="prefetch" href="/assets/js/35.36cdfa73.js"><link rel="prefetch" href="/assets/js/36.985fb65a.js"><link rel="prefetch" href="/assets/js/37.5b7d8c67.js"><link rel="prefetch" href="/assets/js/38.cb779f17.js"><link rel="prefetch" href="/assets/js/39.c741f1db.js"><link rel="prefetch" href="/assets/js/4.11dd4e91.js"><link rel="prefetch" href="/assets/js/40.aea4d1c5.js"><link rel="prefetch" href="/assets/js/41.34049013.js"><link rel="prefetch" href="/assets/js/42.66d14dd3.js"><link rel="prefetch" href="/assets/js/43.e9f48f11.js"><link rel="prefetch" href="/assets/js/44.1b1bbd10.js"><link rel="prefetch" href="/assets/js/45.25b2c483.js"><link rel="prefetch" href="/assets/js/46.fdca3222.js"><link rel="prefetch" href="/assets/js/47.07cc1a51.js"><link rel="prefetch" href="/assets/js/48.955bbd2e.js"><link rel="prefetch" href="/assets/js/49.87f6d00b.js"><link rel="prefetch" href="/assets/js/5.57c5d330.js"><link rel="prefetch" href="/assets/js/50.ae65645a.js"><link rel="prefetch" href="/assets/js/51.0b749571.js"><link rel="prefetch" href="/assets/js/52.e41fd777.js"><link rel="prefetch" href="/assets/js/53.ae90ff4e.js"><link rel="prefetch" href="/assets/js/54.bb1cfd7f.js"><link rel="prefetch" href="/assets/js/55.7d7c5e79.js"><link rel="prefetch" href="/assets/js/56.de83f645.js"><link rel="prefetch" href="/assets/js/57.1782bd4a.js"><link rel="prefetch" href="/assets/js/58.a98e9b3c.js"><link rel="prefetch" href="/assets/js/59.f9f51655.js"><link rel="prefetch" href="/assets/js/6.bc57a6b2.js"><link rel="prefetch" href="/assets/js/60.4af28c59.js"><link rel="prefetch" href="/assets/js/61.bf6eedfc.js"><link rel="prefetch" href="/assets/js/62.a18b99d5.js"><link rel="prefetch" href="/assets/js/63.0b9f5922.js"><link rel="prefetch" href="/assets/js/64.c20a03fd.js"><link rel="prefetch" href="/assets/js/65.e72667a8.js"><link rel="prefetch" href="/assets/js/66.1d4f1bea.js"><link rel="prefetch" href="/assets/js/67.5d7daae5.js"><link rel="prefetch" href="/assets/js/68.e4ba756c.js"><link rel="prefetch" href="/assets/js/69.25946c2f.js"><link rel="prefetch" href="/assets/js/7.4f86dc65.js"><link rel="prefetch" href="/assets/js/70.5caa10aa.js"><link rel="prefetch" href="/assets/js/71.72076007.js"><link rel="prefetch" href="/assets/js/72.94dc5db3.js"><link rel="prefetch" href="/assets/js/73.a67d741b.js"><link rel="prefetch" href="/assets/js/74.b30872cb.js"><link rel="prefetch" href="/assets/js/75.4151ec32.js"><link rel="prefetch" href="/assets/js/76.38d424e5.js"><link rel="prefetch" href="/assets/js/77.25909a93.js"><link rel="prefetch" href="/assets/js/78.d6afe05f.js"><link rel="prefetch" href="/assets/js/79.e8b6361f.js"><link rel="prefetch" href="/assets/js/8.523e678b.js"><link rel="prefetch" href="/assets/js/80.0258ea60.js"><link rel="prefetch" href="/assets/js/81.398362d3.js"><link rel="prefetch" href="/assets/js/82.8d8b1248.js"><link rel="prefetch" href="/assets/js/83.c4f544f2.js"><link rel="prefetch" href="/assets/js/84.99da8de5.js"><link rel="prefetch" href="/assets/js/85.92b066bd.js"><link rel="prefetch" href="/assets/js/86.3229406a.js"><link rel="prefetch" href="/assets/js/87.9771a660.js"><link rel="prefetch" href="/assets/js/88.0b175578.js"><link rel="prefetch" href="/assets/js/89.1f7dffd7.js"><link rel="prefetch" href="/assets/js/9.4f1eaad5.js"><link rel="prefetch" href="/assets/js/90.ef6f44f9.js"><link rel="prefetch" href="/assets/js/91.22da4225.js"><link rel="prefetch" href="/assets/js/92.192e872c.js"><link rel="prefetch" href="/assets/js/93.4f274e91.js"><link rel="prefetch" href="/assets/js/94.7297ec15.js"><link rel="prefetch" href="/assets/js/95.59278457.js"><link rel="prefetch" href="/assets/js/97.279256e2.js"><link rel="prefetch" href="/assets/js/98.d36bef0a.js"><link rel="prefetch" href="/assets/js/99.4e279728.js">
    <link rel="stylesheet" href="/assets/css/0.styles.032ce348.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">山  海</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/main/笔记/" class="nav-link">笔记</a></div><div class="nav-item"><a href="/main/实战/" class="nav-link">实战</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/main/笔记/" class="nav-link">笔记</a></div><div class="nav-item"><a href="/main/实战/" class="nav-link">实战</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/main/笔记/分布式/01_分布式事务.html" class="active sidebar-link">分布式事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/main/笔记/分布式/01_分布式事务.html#强一致性" class="sidebar-link">强一致性</a></li><li class="sidebar-sub-header"><a href="/main/笔记/分布式/01_分布式事务.html#柔性事务" class="sidebar-link">柔性事务</a></li><li class="sidebar-sub-header"><a href="/main/笔记/分布式/01_分布式事务.html#事务消息" class="sidebar-link">事务消息</a></li><li class="sidebar-sub-header"><a href="/main/笔记/分布式/01_分布式事务.html#seata框架" class="sidebar-link">seata框架</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="分布式事务"><a href="#分布式事务" class="header-anchor">#</a> 分布式事务</h1> <p>  首先不管有多丰富的理论知识，还是见过多大的世面，<strong>分布式事务能不用就不用，在业务上避免分布式事务</strong>。</p> <p>  一提到分布式事务，就会联想到MySQL多个库的情况。当与多个数据库建立连接时，就无法在数据库层面对事务进行统一管理。由此，诞生了分布式事务的问题。其实对于其他的存储，也是分布式事务的范畴，比如Redis、MQ、Elasticsearch等。</p> <h2 id="强一致性"><a href="#强一致性" class="header-anchor">#</a> 强一致性</h2> <p><strong>1、一致性协议2PC</strong></p> <img src="/分布式/01_两阶段提交.png" width="500px"> <p>  两阶段提交的意思是，将一次提交分成两个阶段。在第一阶段，<strong>事务协调者</strong>询问各个<strong>事务参与者</strong>能否提交事务。在第二阶段，事务协调者根据第一阶段的响应结果，对所有的事务参与者下达统一提交或者统一回滚的消息，来保证其原子性。</p> <p>  事务协调者在第一阶段了解了事务的走向，<strong>但不能保证第二阶段所有的事务参与者都能够接收到消息</strong>。如果存在事务参与者丢失了消息，就会造成数据不一致的情况。为了解决这个问题，因此出现了3PC。</p> <p><strong>2、一致性协议3PC</strong></p> <img src="/分布式/02_三阶段提交.png" width="500px"> <p>  3PC是在2PC的中间加入了<strong>预提交阶段</strong>。既让事务协调者知道事务可以提交或者回滚，也让事务参与者清楚事务下一步的走向。</p> <p>  在第三阶段提交阶段，如果丢失了事务协调者的消息，事务参与者会等待一定时间，如果超时，就会执行第二阶段的下一步操作。</p> <p><strong>3、落地方案</strong></p> <p><strong>  XA规范</strong>，是支持分布式事务的数据库厂商需要遵循的规范。厂商都是支持到两阶段提交，因为三阶段在理论上可以这么做，而两阶段也只是在理论上有这个问题，但出现的概率太低了。三阶段投入成本太高了，没必要，因此两阶段就够了。如果两阶段提交真的出现问题，那就需要<strong>人工对齐</strong>。</p> <p><strong>4、缺点</strong></p> <p>  在一个分布式事务期间，多个<strong>事务参与者对所操作的资源加锁</strong>，在分布式事务结束时才会释放锁。导致并发起不来，吞吐量受到了影响。因此XA规范很少使用，因为性能损耗大。</p> <p>  为了预防事务协调者挂了，事务协调者在本地需要记录事务执行状态，恢复后该提交的提交。可以弥补两阶段的不足，但如果机器挂了怎么办，所以不支持异地恢复。</p> <h2 id="柔性事务"><a href="#柔性事务" class="header-anchor">#</a> 柔性事务</h2> <p>  在应用时更多地使用柔性事务，<strong>追求最终一致性</strong>。主要有TCC、saga方案。但TCC和saga模式业务方都不愿意用，对业务的侵入太大了，开发效率低。</p> <h3 id="tcc"><a href="#tcc" class="header-anchor">#</a> TCC</h3> <img src="/分布式/03_TCC.png" width="500px"> <p>  TCC（Try-Confirm-Cancel）。有两条流程可以走，一条是<code>try-confirm</code>，另一条是<code>try-cancel</code>流程。</p> <ul><li>Try，尝试执行业务，预留资源。</li> <li>Confirm，确认执行业务，使用Try阶段资源。</li> <li>Cancel，取消执行业务，释放try阶段预留的资源。</li></ul> <p>  比如张三需要给李四转账100元。在try1阶段，首先对张三的账户预留（冻结）100元钱，在try2阶段，检查李四账号是否正常。都OK，在Confirm阶段，给李四账户加钱就可以了。或者在cancel阶段，给张三账户加钱就可以了。</p> <p>  按照正常逻辑好好写，几乎不会出问题。如果按着TCC的方式来写这个逻辑，业务逻辑更复杂了，保不准就会出问题。又没有一个好的机制都保证逻辑都能正常执行，包括容错，所有的逻辑都交给业务去做。有框架时，尽量框架保证。没框架时，业务尽量保证。业务都保证不了时，需要人工介入来修复数据。</p> <h3 id="saga模型"><a href="#saga模型" class="header-anchor">#</a> saga模型</h3> <p>  saga适合做业务流程比较长的情况，是一个长事务。</p> <p>  saga的思想是，将<strong>一个分布式事务拆分为多个本地事务</strong>，就当成多个事务来看，谁和谁都没有关系，<strong>每个本地事务都有相应的执行模块和本地模块</strong>。当任意一个本地事务出错时，事务管理器负责在事务失败时调度执行补偿逻辑。而补偿逻辑需要业务（程序员）来写，对业务的侵入性比较大。</p> <p>  每个接口需要写两个逻辑，一个正向，一个逆向，导致业务量增大，因此许多人不愿意用。</p> <p>  虽然有事务管理器负责调度补偿逻辑，那如果调度补偿逻辑超时怎么办？超时就会重试，如果就是因为处理的慢一些而超时，由于重试可能导致数据不一致，因此这个补偿逻辑还要<strong>保障接口的幂等性</strong>，业务量会更大。</p> <p>  原理是 当开启一个分布式事务时，会申请一个全局事务id，子事务在执行时将本地事务id注册到事务管理器。不必一定要恢复到事务之前的状态。因此可以通过异步补偿的方式，来降级接口（正常执行 + 补偿）的响应时间。sagas架构设计三大关键技术，（1）记录请求调用链路。（2）异步补偿机制。（3）幂等补偿接口。</p> <h2 id="事务消息"><a href="#事务消息" class="header-anchor">#</a> 事务消息</h2> <p>  事务消息简化了分布式事务模型，对业务友好，几乎无侵入。将<code>两次RPC</code>转成了<code>一次RPC + 一个消息的写入</code>。</p> <p>  分布式事务解决了多个数据源的写入的原子性问题。事务消息解决了业务方与发送消息的原子性问题，没有保证后续的接收方处理有没有成功，因此模型简单了。</p> <h3 id="rocketmq-事务消息-两阶段提交方案"><a href="#rocketmq-事务消息-两阶段提交方案" class="header-anchor">#</a> RocketMQ 事务消息 两阶段提交方案</h3> <p>  （1）消息发送方，发送一条 prepare消息 到 MQ Server。</p> <p>  （2）MQ Server响应发送成功到 消息发送方。</p> <p>  （3）消息发送方执行本地事务，发送COMMIT/rollback消息到MQ Server。</p> <p>  （4）MQ Server长时间未收到消息，就会回查本地事务的结果。</p> <p>  （5）MQ Server接收到消息，处理 prepare消息，是投递还是丢弃。</p> <p>  问题。业务方需要提供回查接口，对业务侵入比较大。只有特定的MQ支持两阶段提交。</p> <h3 id="通用设计"><a href="#通用设计" class="header-anchor">#</a> 通用设计</h3> <p><strong>1、保证消息发送方的成功发送</strong></p> <p>  消息发送方，维护一张消息表，与业务表放在同一本地事务中执行。后台启动一个线程，定时扫描消息表的数据投递到MQ服务端，MQ服务端响应ACK到消息发送方，更新消息表的发送状态。确保消息投放稳定。如果长时间收不到MQ服务端的ack消息，在下一轮定时任务到时，会出现发送重复消息的情况。MQ服务端最少会持有一份数据的消息。</p> <p><strong>2、保证消息接收方的成功处理</strong></p> <p>  消息接收方，需要确保接口的幂等性。</p> <p>  消息接收方通常会部署多个，MQ服务端也可能同时收到同一条消息多次。在同一时间可能有多个消息接收方<strong>并行处理同一条消息</strong>。此时就需要判断消息接收方的业务逻辑，如果影响的数据量是一定的，比如删除一次和删除多次的效果是等价的，因为删除操作天然是幂等性的，也不需要做去重处理。而如果是插入操作，要保证只能执行一次，丢弃其他的执行，可以通过分布式锁的方式来保证执行的唯一性。</p> <p>  使用事务消息的异步场景下，如果消息接收方是无状态化的，可以通过横向拓展来大大提升吞吐量。MQ服务端也可以通过搭建集群，也加大吞吐量。响应延时由于中间的节点增多而加大，通过加机器的方式来保证延迟在可接收范围之内。</p> <h2 id="seata框架"><a href="#seata框架" class="header-anchor">#</a> seata框架</h2> <img src="/分布式/04_seata.png" width="560px"> <p><strong>1、流程</strong></p> <p>  （1）TM向TC 申请开启一个全局事务，TC创建全局事务后返回唯一的全局XID。XID会在全局事务的上下文中传播。</p> <p>  （2）RM向TC注册分支事务，该分支事务归属于拥有相同XID的全局事务。</p> <p>  （3）TM向TC发起全局提交或回滚。</p> <p>  （4）TC调度XID下的分支事务完成提交或者回滚。</p> <h3 id="at模式"><a href="#at模式" class="header-anchor">#</a> AT模式</h3> <p>  AT模式是一种无侵入的分布式事务解决方案，2PC的广义实现，可以应对大多数的业务场景。其特点是：<strong>低成本</strong>，编程模型不变，轻依赖不需要为分布式事务场景做特定设计。<strong>高性能</strong>，一阶段提交，不阻塞；连接释放，保证整个系统的吞吐量。<strong>高可用</strong>，在极端的异常情况下，可以暂时跳过异常事务，保证系统可用，需要人工介入。</p> <p>  TCC、SAGA、AT模式在第一阶段就提交了，<strong>既然提交就不阻塞，连接释放，保证系统的吞吐量</strong>。</p> <p>  XA为什么慢呢？不只有锁的问题，还有数据库连接的问题。当我们的服务访问数据库时，线程是独占连接的，只要事务不提交，线程就会一直持有连接，其他线程用不了。如果有许多的分布式事务在执行，连接都被线程占用着，其他工作连接就拿不到连接用了，就影响了吞吐量。</p> <h3 id="执行原理"><a href="#执行原理" class="header-anchor">#</a> 执行原理</h3> <p>  业务通过RM去访问数据库，在第一阶段，RM拦截业务SQL，生成前镜像（执行业务之前的数据，业务回滚可以用前镜像恢复），生成后镜像，这些内容记录在undo_log中。在第二阶段，TC向所有的RM发起提交或者回滚。</p> <p>  二阶段如何<strong>提交分布式事务</strong>，删除记录的undo_log即可。具体的业务本地事务在第一阶段已经提交了。</p> <p>  二阶段如何<strong>回滚分布式事务</strong>，说是叫回滚，其实是基于undo_log里的前镜像做逆向操作。</p> <p><strong>1、如何回滚？</strong></p> <p>  要防止其他事务对数据的修改，比如其他分布式事务的修改，和非分布式事务的修改。</p> <p>  比如分布式事务A的分支事务A1，修改了用户的钱数为100，记录前镜像为50，记录后镜像为100。此时分布式事务B来了，修改了用户的钱数为200，记录前镜像为100，后镜像为200。</p> <p>  如果分布式事务A需要进行回滚，那将钱数回滚为50吗？明显是不对的！因此要注意其他分布式事务的修改，也要注意非分布式事务的修改，比如商家增加商品的库存为1000，其中一个分布式事务给回滚成10了。</p> <p>  在本地事务中的行锁就起了至关重要的作用。而业务已经在第一阶段提交了，行锁被释放就无法锁住资源，因为要使用分布式事务特殊的行锁（分布式锁）。</p> <p><strong>2、回滚逻辑</strong></p> <p>  （1）校验脏写。回滚时通过undo_log获取后镜像，再查一下当前数据的最新数据。当后镜像与最新数据不同时，代表分布式事务期间数据被其他事务修改了，这就是<strong>脏写</strong>，不能直接基于前镜像进行回滚了。校验出脏写了，就需要人工介入恢复。</p> <p>  （2）如果校验脏写通过了，根据前后镜像生成逆向SQL还原数据。</p> <p>  （3）删除前后镜像。</p> <p><strong>3、如何防止脏写</strong></p> <p>  用户下单减库存，将库存扣减这个事情通过分布式锁锁住，每个下单都是独立的分布式事务，都有不同的XID，只要在seata框架下管理的分布式事务遵循同样的分布式锁的规则就可以了。</p> <p>  商家增加库存这种非分布式事务，不受seata管理，有可能会发生脏写。有个注解<code>@GlobalLock</code>，对这个事务所作的操作同样去访问分布式锁。</p> <p>  如果脏写发生了，只能通过人工介入。</p> <p>  如果不检查全局锁（分布式锁），锁失效。</p> <h3 id="隔离级别"><a href="#隔离级别" class="header-anchor">#</a> 隔离级别</h3> <p>  分布式事务的隔离级别，比如saga、TCC在第一阶段就提交了，因此默认为读未提交。</p> <p>  seata的写隔离。分支事务提交前拿到全局锁，在分布式事务提交时释放全局锁。</p> <p>  分布式事务A拿到了全局锁，需要回滚，等待行锁。分布式事务B拿到了行锁，等待全局锁，这就产生了死锁。有一个约定是拿全局锁超时，回滚本地事务，释放本地锁，那就回滚分布式事务B。</p> <p>  seata的读隔离。默认全局隔离级别是读未提交。如何做到读已提交呢？查询时使用<code>select for update</code>实现读已提交，在查询时需要获取全局锁，再有其他分布式事务未提交时，查询数据时阻塞读不出数据来实现读已提交。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">3/31/2021, 11:09:45 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.132ddbf7.js" defer></script><script src="/assets/js/2.5c2f89f7.js" defer></script><script src="/assets/js/96.5ee2802b.js" defer></script>
  </body>
</html>
