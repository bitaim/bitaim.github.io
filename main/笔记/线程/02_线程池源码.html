<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>线程池源码 | 山  海</title>
    <meta name="description" content="">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.032ce348.css" as="style"><link rel="preload" href="/assets/js/app.132ddbf7.js" as="script"><link rel="preload" href="/assets/js/2.5c2f89f7.js" as="script"><link rel="preload" href="/assets/js/157.381cd390.js" as="script"><link rel="prefetch" href="/assets/js/10.0e53bce9.js"><link rel="prefetch" href="/assets/js/100.6ebbdd4f.js"><link rel="prefetch" href="/assets/js/101.465a8446.js"><link rel="prefetch" href="/assets/js/102.3e4485c8.js"><link rel="prefetch" href="/assets/js/103.b9aca84b.js"><link rel="prefetch" href="/assets/js/104.83e2125c.js"><link rel="prefetch" href="/assets/js/105.7722414c.js"><link rel="prefetch" href="/assets/js/106.c351687d.js"><link rel="prefetch" href="/assets/js/107.fa9bae79.js"><link rel="prefetch" href="/assets/js/108.5a17a170.js"><link rel="prefetch" href="/assets/js/109.23a9fdc4.js"><link rel="prefetch" href="/assets/js/11.924d2005.js"><link rel="prefetch" href="/assets/js/110.a95e4813.js"><link rel="prefetch" href="/assets/js/111.87293fb4.js"><link rel="prefetch" href="/assets/js/112.5a192052.js"><link rel="prefetch" href="/assets/js/113.aea18fa8.js"><link rel="prefetch" href="/assets/js/114.217fed2e.js"><link rel="prefetch" href="/assets/js/115.ec9ea823.js"><link rel="prefetch" href="/assets/js/116.7c935041.js"><link rel="prefetch" href="/assets/js/117.7051ab5d.js"><link rel="prefetch" href="/assets/js/118.7c248185.js"><link rel="prefetch" href="/assets/js/119.4521d1a6.js"><link rel="prefetch" href="/assets/js/12.8e426061.js"><link rel="prefetch" href="/assets/js/120.e129c4ce.js"><link rel="prefetch" href="/assets/js/121.8f8613fd.js"><link rel="prefetch" href="/assets/js/122.5a226edf.js"><link rel="prefetch" href="/assets/js/123.70c2e7ac.js"><link rel="prefetch" href="/assets/js/124.816c27e2.js"><link rel="prefetch" href="/assets/js/125.808eee8b.js"><link rel="prefetch" href="/assets/js/126.ad8ad6d0.js"><link rel="prefetch" href="/assets/js/127.0de99521.js"><link rel="prefetch" href="/assets/js/128.c81d68f9.js"><link rel="prefetch" href="/assets/js/129.5c50d9ed.js"><link rel="prefetch" href="/assets/js/13.438078b4.js"><link rel="prefetch" href="/assets/js/130.4e2a0154.js"><link rel="prefetch" href="/assets/js/131.9297dfd6.js"><link rel="prefetch" href="/assets/js/132.f104fb6c.js"><link rel="prefetch" href="/assets/js/133.9dafb982.js"><link rel="prefetch" href="/assets/js/134.65484ddd.js"><link rel="prefetch" href="/assets/js/135.80f7f732.js"><link rel="prefetch" href="/assets/js/136.7ff538d3.js"><link rel="prefetch" href="/assets/js/137.6799273a.js"><link rel="prefetch" href="/assets/js/138.7ec0f371.js"><link rel="prefetch" href="/assets/js/139.75e909d6.js"><link rel="prefetch" href="/assets/js/14.c8888a94.js"><link rel="prefetch" href="/assets/js/140.b8c3932f.js"><link rel="prefetch" href="/assets/js/141.fe4623aa.js"><link rel="prefetch" href="/assets/js/142.ea8fdd79.js"><link rel="prefetch" href="/assets/js/143.f7dadd18.js"><link rel="prefetch" href="/assets/js/144.406f6645.js"><link rel="prefetch" href="/assets/js/145.07c7928f.js"><link rel="prefetch" href="/assets/js/146.d1d17b80.js"><link rel="prefetch" href="/assets/js/147.978eb34e.js"><link rel="prefetch" href="/assets/js/148.90fe445e.js"><link rel="prefetch" href="/assets/js/149.fed37972.js"><link rel="prefetch" href="/assets/js/15.e61179b0.js"><link rel="prefetch" href="/assets/js/150.5016dd45.js"><link rel="prefetch" href="/assets/js/151.5ecd4445.js"><link rel="prefetch" href="/assets/js/152.7bdd1a37.js"><link rel="prefetch" href="/assets/js/153.7fb72daf.js"><link rel="prefetch" href="/assets/js/154.641d5144.js"><link rel="prefetch" href="/assets/js/155.ce96a899.js"><link rel="prefetch" href="/assets/js/156.114b3ec1.js"><link rel="prefetch" href="/assets/js/158.3f20083b.js"><link rel="prefetch" href="/assets/js/159.c8330a64.js"><link rel="prefetch" href="/assets/js/16.6278237b.js"><link rel="prefetch" href="/assets/js/160.97ae5e26.js"><link rel="prefetch" href="/assets/js/161.e6fb65d1.js"><link rel="prefetch" href="/assets/js/162.c41da870.js"><link rel="prefetch" href="/assets/js/163.a8fe6406.js"><link rel="prefetch" href="/assets/js/164.05ae7d96.js"><link rel="prefetch" href="/assets/js/165.9b13122c.js"><link rel="prefetch" href="/assets/js/166.522bff26.js"><link rel="prefetch" href="/assets/js/167.c990ffce.js"><link rel="prefetch" href="/assets/js/168.a9b90b42.js"><link rel="prefetch" href="/assets/js/169.45fefdd0.js"><link rel="prefetch" href="/assets/js/17.fbb8cc26.js"><link rel="prefetch" href="/assets/js/170.b001a6e2.js"><link rel="prefetch" href="/assets/js/171.4d0a131f.js"><link rel="prefetch" href="/assets/js/172.a8fcf5ee.js"><link rel="prefetch" href="/assets/js/173.9cb87116.js"><link rel="prefetch" href="/assets/js/174.2f9cc0ec.js"><link rel="prefetch" href="/assets/js/175.5a659117.js"><link rel="prefetch" href="/assets/js/176.fcf0aff4.js"><link rel="prefetch" href="/assets/js/177.50fc6167.js"><link rel="prefetch" href="/assets/js/178.fee25f22.js"><link rel="prefetch" href="/assets/js/179.853a6e53.js"><link rel="prefetch" href="/assets/js/18.c98b197e.js"><link rel="prefetch" href="/assets/js/180.4ad7d812.js"><link rel="prefetch" href="/assets/js/181.7292d4e8.js"><link rel="prefetch" href="/assets/js/182.06606085.js"><link rel="prefetch" href="/assets/js/183.4c6b6372.js"><link rel="prefetch" href="/assets/js/184.4851c62d.js"><link rel="prefetch" href="/assets/js/185.f0f059bd.js"><link rel="prefetch" href="/assets/js/186.642a3feb.js"><link rel="prefetch" href="/assets/js/187.acc0c0cd.js"><link rel="prefetch" href="/assets/js/188.8207ebe7.js"><link rel="prefetch" href="/assets/js/189.d1962896.js"><link rel="prefetch" href="/assets/js/19.0d55b57e.js"><link rel="prefetch" href="/assets/js/190.97cf8985.js"><link rel="prefetch" href="/assets/js/191.4127dde3.js"><link rel="prefetch" href="/assets/js/192.e3ac05e2.js"><link rel="prefetch" href="/assets/js/193.ec3499fb.js"><link rel="prefetch" href="/assets/js/194.0df296a1.js"><link rel="prefetch" href="/assets/js/20.1e112538.js"><link rel="prefetch" href="/assets/js/21.9c9c4453.js"><link rel="prefetch" href="/assets/js/22.5308710a.js"><link rel="prefetch" href="/assets/js/23.7b3d62e9.js"><link rel="prefetch" href="/assets/js/24.9d4ba8c5.js"><link rel="prefetch" href="/assets/js/25.4e2505d4.js"><link rel="prefetch" href="/assets/js/26.4bf8feed.js"><link rel="prefetch" href="/assets/js/27.5419d111.js"><link rel="prefetch" href="/assets/js/28.3390255e.js"><link rel="prefetch" href="/assets/js/29.2901b68d.js"><link rel="prefetch" href="/assets/js/3.2f8e8ebb.js"><link rel="prefetch" href="/assets/js/30.ca79da09.js"><link rel="prefetch" href="/assets/js/31.dc32b8cb.js"><link rel="prefetch" href="/assets/js/32.d086b22e.js"><link rel="prefetch" href="/assets/js/33.24491803.js"><link rel="prefetch" href="/assets/js/34.a1c2324b.js"><link rel="prefetch" href="/assets/js/35.36cdfa73.js"><link rel="prefetch" href="/assets/js/36.985fb65a.js"><link rel="prefetch" href="/assets/js/37.5b7d8c67.js"><link rel="prefetch" href="/assets/js/38.cb779f17.js"><link rel="prefetch" href="/assets/js/39.c741f1db.js"><link rel="prefetch" href="/assets/js/4.11dd4e91.js"><link rel="prefetch" href="/assets/js/40.aea4d1c5.js"><link rel="prefetch" href="/assets/js/41.34049013.js"><link rel="prefetch" href="/assets/js/42.66d14dd3.js"><link rel="prefetch" href="/assets/js/43.e9f48f11.js"><link rel="prefetch" href="/assets/js/44.1b1bbd10.js"><link rel="prefetch" href="/assets/js/45.25b2c483.js"><link rel="prefetch" href="/assets/js/46.fdca3222.js"><link rel="prefetch" href="/assets/js/47.07cc1a51.js"><link rel="prefetch" href="/assets/js/48.955bbd2e.js"><link rel="prefetch" href="/assets/js/49.87f6d00b.js"><link rel="prefetch" href="/assets/js/5.57c5d330.js"><link rel="prefetch" href="/assets/js/50.ae65645a.js"><link rel="prefetch" href="/assets/js/51.0b749571.js"><link rel="prefetch" href="/assets/js/52.e41fd777.js"><link rel="prefetch" href="/assets/js/53.ae90ff4e.js"><link rel="prefetch" href="/assets/js/54.bb1cfd7f.js"><link rel="prefetch" href="/assets/js/55.7d7c5e79.js"><link rel="prefetch" href="/assets/js/56.de83f645.js"><link rel="prefetch" href="/assets/js/57.1782bd4a.js"><link rel="prefetch" href="/assets/js/58.a98e9b3c.js"><link rel="prefetch" href="/assets/js/59.f9f51655.js"><link rel="prefetch" href="/assets/js/6.bc57a6b2.js"><link rel="prefetch" href="/assets/js/60.4af28c59.js"><link rel="prefetch" href="/assets/js/61.bf6eedfc.js"><link rel="prefetch" href="/assets/js/62.a18b99d5.js"><link rel="prefetch" href="/assets/js/63.0b9f5922.js"><link rel="prefetch" href="/assets/js/64.c20a03fd.js"><link rel="prefetch" href="/assets/js/65.e72667a8.js"><link rel="prefetch" href="/assets/js/66.1d4f1bea.js"><link rel="prefetch" href="/assets/js/67.5d7daae5.js"><link rel="prefetch" href="/assets/js/68.e4ba756c.js"><link rel="prefetch" href="/assets/js/69.25946c2f.js"><link rel="prefetch" href="/assets/js/7.4f86dc65.js"><link rel="prefetch" href="/assets/js/70.5caa10aa.js"><link rel="prefetch" href="/assets/js/71.72076007.js"><link rel="prefetch" href="/assets/js/72.94dc5db3.js"><link rel="prefetch" href="/assets/js/73.a67d741b.js"><link rel="prefetch" href="/assets/js/74.b30872cb.js"><link rel="prefetch" href="/assets/js/75.4151ec32.js"><link rel="prefetch" href="/assets/js/76.38d424e5.js"><link rel="prefetch" href="/assets/js/77.25909a93.js"><link rel="prefetch" href="/assets/js/78.d6afe05f.js"><link rel="prefetch" href="/assets/js/79.e8b6361f.js"><link rel="prefetch" href="/assets/js/8.523e678b.js"><link rel="prefetch" href="/assets/js/80.0258ea60.js"><link rel="prefetch" href="/assets/js/81.398362d3.js"><link rel="prefetch" href="/assets/js/82.8d8b1248.js"><link rel="prefetch" href="/assets/js/83.c4f544f2.js"><link rel="prefetch" href="/assets/js/84.99da8de5.js"><link rel="prefetch" href="/assets/js/85.92b066bd.js"><link rel="prefetch" href="/assets/js/86.3229406a.js"><link rel="prefetch" href="/assets/js/87.9771a660.js"><link rel="prefetch" href="/assets/js/88.0b175578.js"><link rel="prefetch" href="/assets/js/89.1f7dffd7.js"><link rel="prefetch" href="/assets/js/9.4f1eaad5.js"><link rel="prefetch" href="/assets/js/90.ef6f44f9.js"><link rel="prefetch" href="/assets/js/91.22da4225.js"><link rel="prefetch" href="/assets/js/92.192e872c.js"><link rel="prefetch" href="/assets/js/93.4f274e91.js"><link rel="prefetch" href="/assets/js/94.7297ec15.js"><link rel="prefetch" href="/assets/js/95.59278457.js"><link rel="prefetch" href="/assets/js/96.5ee2802b.js"><link rel="prefetch" href="/assets/js/97.279256e2.js"><link rel="prefetch" href="/assets/js/98.d36bef0a.js"><link rel="prefetch" href="/assets/js/99.4e279728.js">
    <link rel="stylesheet" href="/assets/css/0.styles.032ce348.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">山  海</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/main/笔记/" class="nav-link">笔记</a></div><div class="nav-item"><a href="/main/实战/" class="nav-link">实战</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/main/笔记/" class="nav-link">笔记</a></div><div class="nav-item"><a href="/main/实战/" class="nav-link">实战</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/main/笔记/线程/01_线程.html" class="sidebar-link">线程</a></li><li><a href="/main/笔记/线程/02_线程池.html" class="sidebar-link">线程池</a></li><li><a href="/main/笔记/线程/02_线程池源码.html" class="active sidebar-link">线程池源码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/main/笔记/线程/02_线程池源码.html#属性" class="sidebar-link">属性</a></li><li class="sidebar-sub-header"><a href="/main/笔记/线程/02_线程池源码.html#执行任务" class="sidebar-link">执行任务</a></li><li class="sidebar-sub-header"><a href="/main/笔记/线程/02_线程池源码.html#创建worker" class="sidebar-link">创建Worker</a></li><li class="sidebar-sub-header"><a href="/main/笔记/线程/02_线程池源码.html#运行worker" class="sidebar-link">运行Worker</a></li><li class="sidebar-sub-header"><a href="/main/笔记/线程/02_线程池源码.html#处理worker退出" class="sidebar-link">处理Worker退出</a></li><li class="sidebar-sub-header"><a href="/main/笔记/线程/02_线程池源码.html#尝试终止线程池" class="sidebar-link">尝试终止线程池</a></li></ul></li><li><a href="/main/笔记/线程/03_异步.html" class="sidebar-link">异步</a></li><li><a href="/main/笔记/线程/04_ThreadLocal.html" class="sidebar-link">ThreadLocal</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="线程池源码"><a href="#线程池源码" class="header-anchor">#</a> 线程池源码</h1> <h4 id="核心线程数-最大线程数"><a href="#核心线程数-最大线程数" class="header-anchor">#</a> 核心线程数 最大线程数</h4> <p>  线程池会根据设定的两个参数界限  <code>corePoolSize</code> 和  <code>maximumPoolSize</code>，自动调整线程的数量。同时这两个参数可以<strong>动态调整</strong>。</p> <p>  当提交一个新任务时，就会判断 如果当前池中的线程数小于核心线程数，即使当前已存在的工作线程处于空闲状态，也会创建一个新线程来处理请求。当构建Worker时，直接将Runnable任务构建进去，不需要加入队列。</p> <p>  当提交一个新任务时，判断 当前池中的线程数大于等于核心线程数，但是小于最大线程数，并且队列已经满了。就会创建一个新的线程来处理请求，同时将Runnable任务构建进去。</p> <h4 id="超时时间"><a href="#超时时间" class="header-anchor">#</a> 超时时间</h4> <p>  当池中的线程数大于核心线程数时，这些过量的线程会由于空闲一定的时间而被终止。由参数  <code>keepAliveTime</code> 决定，该参数可以<strong>动态调整</strong>。 如果之后再有更大的需求，线程又会被创建出来。默认情况下，超时策略只会让超量的线程终止。但是可以通过 <code>allowCoreThreadTimeOut</code> 参数让所有的线程终止。</p> <h4 id="线程工厂"><a href="#线程工厂" class="header-anchor">#</a> 线程工厂</h4> <p>  线程是由  <code>ThreadFactory</code> 创建的，创建出的线程属于同一个线程组，相同的优先级，非守护状态。可以指定线程工厂类（自定义线程名、优先级等），或者使用默认的线程工厂类。线程工厂创建线程时可能会失败，导致新任务被拒绝或现有任务仍停留在队列中。</p> <p>  默认情况下，当任务到达时，核心线程才会被创建。但是可以通过重写  <code>prestartCoreThread</code> 或者  <code>prestartAllCoreThreads</code> 方法，来预启动线程（比如指定一个非空队列）。</p> <h4 id="阻塞队列"><a href="#阻塞队列" class="header-anchor">#</a> 阻塞队列</h4> <p>  队列使用的是 <code>BlockingQueue</code> 下的子类队列，常用的有三种队列 <code>ArrayBlockingQueue</code> 、 <code>LinkedBlockingQueue</code> 和  <code>SynchronousQueue</code> 。</p> <p><strong>  SynchronousQueue队列</strong> 。不存储（持有）任务，而是将任务转交给线程去处理。如果没有线程去处理那么将会失败，通常需要设定一个无限大的最大线程数。如果任务提交速度大于任务处理速度，那么会导致线程数量无限增大。比如<code>Executors.newCachedThreadPool()</code>线程池，使用的是该阻塞队列。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span>  
                                  <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>  
                                  <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre></div> <p><strong>  LinkedBlockingQueue队列</strong>，是一个无界（有界，需要指定容量）队列。因此可存储无限量的任务，那么最大线程数将会不起作用。只会创建核心线程数量的线程，如果处理速度过慢，那么会导致队列长度的无限增大。比如<code>Executors.newFixedThreadPool()</code>线程池，使用的是该阻塞队列。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> nThreads<span class="token punctuation">,</span>  
                                  <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>  
                                  <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FinalizableDelegatedExecutorService</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                                <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>  ArrayBlockingQueue队列</strong>，是一个有界队列。与最大线程数配合使用，可以防止资源消耗，但需要权衡参数如何调整。</p> <h4 id="拒绝策略"><a href="#拒绝策略" class="header-anchor">#</a> 拒绝策略</h4> <p>  AbortPolicy（默认策略），中止策略。抛出 RejectedExecutionException 异常。</p> <p>  CallerRunsPlocy，由本身线程负责执行，将会减少新任务的提交速度。</p> <p>  DiscardPolicy，直接丢弃。</p> <p>  DiscardOldestPolicy，丢弃最老的任务。</p> <h4 id="钩子函数"><a href="#钩子函数" class="header-anchor">#</a> 钩子函数</h4> <p>  两个空实现钩子函数，<code>beforeExecute</code>、<code>afterExecute</code>，在任务执行前后被执行。可以通过继承<code>ThreadPoolExecutor</code>来自定义线程池，利用钩子函数实现自身的业务需求。</p> <h2 id="属性"><a href="#属性" class="header-anchor">#</a> 属性</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 通过 AtomicInteger 对 workerCount（工作线程数量） 和 runState（运行状态） 属性进行了包装</span>
<span class="token comment">// 使用 高3位存储 runState，使用 剩余29位存储 workerCount</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span>RUNNING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Integer.size ，返回 二进制的位数，也就是32</span>
<span class="token comment">// COUNT_BITS 为 29</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COUNT_BITS <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>SIZE <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">// (2^29) - 1 ，表示 工作线程数的最大数量</span>
<span class="token comment">// 00011111 11111111 11111111 11111111 </span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CAPACITY  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// 运行状态有5种。</span>
<span class="token comment">// （1）RUNNING：可接收新任务，可以处理队列中的任务。</span>
<span class="token comment">// （2）SHUTDOWN：不可接收新任务，但可以处理队列中的任务。</span>
<span class="token comment">// （3）STOP：不可接收新任务，不处理队列中的任务，并且中断进行中的任务。</span>
<span class="token comment">// （4）TIDYING：所有任务已终止，工作线程数为0。调用 terminated() 钩子函数。</span>
<span class="token comment">// （5）TERMINATED：terminated() 钩子函数执行完毕。</span>

<span class="token comment">// 运行状态之间的转换。</span>
<span class="token comment">// RUNNING -&gt; SHUTDOWN，主动调用 shutdown()方法，或者线程池被垃圾回收时触发 finalize()方法</span>
<span class="token comment">// (RUNNING or SHUTDOWN) -&gt; STOP，主动调用 shutdownNow()方法</span>
<span class="token comment">// SHUTDOWN -&gt; TIDYING，当工作线程数和队列都为空时</span>
<span class="token comment">// STOP -&gt; TIDYING，当工作线程数为空时</span>
<span class="token comment">// TIDYING -&gt; TERMINATED，当执行完 terminated()钩子函数</span>

<span class="token comment">// 11100000 00000000 00000000 00000000</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> RUNNING    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>
<span class="token comment">// 00000000 00000000 00000000 00000000（0的二进制后加29个0）</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHUTDOWN   <span class="token operator">=</span>  <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>
<span class="token comment">// 00100000 00000000 00000000 00000000（1的二进制后加29个0）</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> STOP       <span class="token operator">=</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>
<span class="token comment">// 01000000 00000000 00000000 00000000（2的二进制后加29个0）</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TIDYING    <span class="token operator">=</span>  <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>
<span class="token comment">// 01100000 00000000 00000000 00000000（3的二进制后加29个0）</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TERMINATED <span class="token operator">=</span>  <span class="token number">3</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>

<span class="token comment">// 获取线程池的状态</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>     <span class="token punctuation">{</span> <span class="token keyword">return</span> c <span class="token operator">&amp;</span> <span class="token operator">~</span>CAPACITY<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">// 获取工作线程的数量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>  <span class="token punctuation">{</span> <span class="token keyword">return</span> c <span class="token operator">&amp;</span> CAPACITY<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">// rs | wc 进行与运算，也就是将两个值的特征转化为一个int值</span>
<span class="token comment">// 该方法是为了修改ctl的值</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> rs<span class="token punctuation">,</span> <span class="token keyword">int</span> wc<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> rs <span class="token operator">|</span> wc<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre></div><h2 id="执行任务"><a href="#执行任务" class="header-anchor">#</a> 执行任务</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 工作线程的数量 小于 核心线程数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建核心工作线程执行任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 创建核心工作线程成功，直接返回</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token comment">// 重新获取ctl的值</span>
        c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 线程池正在运行，将任务添加到队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 再次校验</span>
        <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 线程池非运行状态（均不再接收新任务），则移除任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 拒绝任务，执行拒绝策略</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 线程池为运行状态，工作线程数为0（概率很小吧）</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">// 创建非核心线程</span>
            <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// （1）线程池非运行状态（SHUTDOWN、STOP、TIDYING、TERMINATED状态）</span>
    <span class="token comment">//     这些状态下，创建Worker均会失败（详情看addWorker()解析）</span>
    <span class="token comment">// （2）队列已经满了，创建非核心Worker处理任务</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建Worker失败，拒绝任务，执行拒绝策略</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
        
<span class="token punctuation">}</span>
</code></pre></div><h2 id="创建worker"><a href="#创建worker" class="header-anchor">#</a> 创建Worker</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span>
        <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span>
        <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * This class will never be serialized, but we provide a
     * serialVersionUID to suppress a javac warning.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">6138294804551838833L</span><span class="token punctuation">;</span>

    <span class="token comment">/** Thread this worker is running in.  Null if factory fails. */</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>
    <span class="token comment">/** Initial task to run.  Possibly null. */</span>
    <span class="token class-name">Runnable</span> firstTask<span class="token punctuation">;</span>
    <span class="token comment">/** Per-thread task counter */</span>
    <span class="token keyword">volatile</span> <span class="token keyword">long</span> completedTasks<span class="token punctuation">;</span>

    <span class="token comment">/**
        * Creates with given first task and thread from ThreadFactory.
        * @param firstTask the first task (null if none)
        */</span>
    <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置state为-1</span>
        <span class="token comment">// 只有执行runWorker之后，才可以被中断。在之前避免被中断</span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// inhibit interrupts until runWorker</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>firstTask <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token function">getThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** Delegates main run loop to outer runWorker  */</span>
    <span class="token comment">// Runnable的实现</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Lock methods</span>
    <span class="token comment">//</span>
    <span class="token comment">// The value 0 represents the unlocked state.</span>
    <span class="token comment">// The value 1 represents the locked state.</span>

    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 基于AQS简单的实现加锁解锁方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">// 中断运行中的Worker</span>
    <span class="token keyword">void</span> <span class="token function">interruptIfStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t<span class="token punctuation">;</span>
        <span class="token comment">// state大于等于0的才可以被中断，构造Worker时初始为-1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> thread<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">,</span> <span class="token keyword">boolean</span> core<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    retry<span class="token operator">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取线程池的运行状态</span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        
        <span class="token comment">// 一、检查线程池状态</span>
        <span class="token comment">// （1）STOP、TIDYING、TERMINATED状态，拒绝创建Worker</span>
        <span class="token comment">// （2）SHUTDOWN状态，firstTask 任务不为null，拒绝创建Worker（SHUTDOWN状态了，不允许提交新任务了，只允许处理队列中的任务）</span>
        <span class="token comment">// （3）SHUTDOWN状态，如果队列为空，拒绝创建Worker</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> SHUTDOWN <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span> <span class="token punctuation">(</span>rs <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 能够到这的，这种两种情况</span>
        <span class="token comment">// （1）线程池处于RUNNING状态</span>
        <span class="token comment">// （2）线程池处于SHUTDOWN状态，firstTask为null，并且队列不为空</span>
           
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// 二、检查线程数是否达到上限</span>
            <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// （1）如果工作线程数量大于等于上限值</span>
            <span class="token comment">// （2）根据core，判断工作线程数是否大于等于 核心线程数 或者 最大线程数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;=</span> CAPACITY <span class="token operator">||</span>
                wc <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>core <span class="token operator">?</span> corePoolSize <span class="token operator">:</span> maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 创建工作线程失败，返回false</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// 增加工作线程数成功</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndIncrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 跳出死循环</span>
                <span class="token keyword">break</span> retry<span class="token punctuation">;</span>
            c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Re-read ctl</span>
            <span class="token comment">// 如果线程池的状态变化了，则重新进入死循环</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> rs<span class="token punctuation">)</span>
                <span class="token keyword">continue</span> retry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> workerStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> workerAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">Worker</span> w <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建新的工作线程</span>
        w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Thread</span> t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 全局加锁</span>
            <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
            mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 再次检查</span>
                <span class="token comment">// （1）线程池状态为运行状态</span>
                <span class="token comment">// （2）线程池状态为SHUTDOWN状态，并且新任务为空（创建新线程帮助处理队列中的任务） </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;</span> SHUTDOWN <span class="token operator">||</span>
                    <span class="token punctuation">(</span>rs <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// precheck that t is startable</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 保存工作线程</span>
                    workers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> s <span class="token operator">=</span> workers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;</span> largestPoolSize<span class="token punctuation">)</span>
                        largestPoolSize <span class="token operator">=</span> s<span class="token punctuation">;</span>
                    workerAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// 解锁</span>
                mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 工作线程添加成功</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>workerAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 启动线程</span>
                t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                workerStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// Worker启动失败</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>workerStarted<span class="token punctuation">)</span>
            <span class="token function">addWorkerFailed</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> workerStarted<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addWorkerFailed</span><span class="token punctuation">(</span><span class="token class-name">Worker</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
    mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Worker不为null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">// 移除失败的Worker</span>
            workers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 减少Worker数量</span>
        <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Worker创建失败可能是由于线程池的状态，所以尝试中止线程池</span>
        <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="运行worker"><a href="#运行worker" class="header-anchor">#</a> 运行Worker</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">Worker</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> task <span class="token operator">=</span> w<span class="token punctuation">.</span>firstTask<span class="token punctuation">;</span>
    <span class="token comment">// Worker断开与Runnable的引用</span>
    w<span class="token punctuation">.</span>firstTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 state值 从 -1 修改为 0（开始允许线程被中断）</span>
    w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// allow interrupts</span>
    <span class="token keyword">boolean</span> completedAbruptly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// （1）任务不为空</span>
        <span class="token comment">// （2）任务为空，从队列中获取到任务（可能获取的任务为null）</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 如果线程池正在停止，确保线程被中断。</span>
            <span class="token comment">// 如果没有停止，确保线程不被中断。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>wt<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 中断线程</span>
                wt<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 执行前钩子</span>
                <span class="token function">beforeExecute</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Throwable</span> thrown <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 前方虽然中断线程，但要在我们的任务中响应中断</span>
                    <span class="token comment">// 执行任务</span>
                    task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 执行后钩子</span>
                    <span class="token function">afterExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// 执行完，任务为null，帮助gc</span>
                task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">// Worker完成任务数 + 1</span>
                w<span class="token punctuation">.</span>completedTasks<span class="token operator">++</span><span class="token punctuation">;</span>
                w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 拿不到任务，跳过死循环</span>
        completedAbruptly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理Worker退出</span>
        <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> completedAbruptly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取任务</span>
<span class="token keyword">private</span> <span class="token class-name">Runnable</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// Did the last poll() time out?</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        
        <span class="token comment">// 一、判断线程池状态，直接返回null的情况</span>
        <span class="token comment">// （1）线程池状态为 SHUTDOWN，队列为空，返回null</span>
        <span class="token comment">// （2）线程池状态为STOP、TIDYING、TERMINATED， 直接返回null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> STOP <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 可运行到这里的情况</span>
        <span class="token comment">// （1）RUNNING状态</span>
        <span class="token comment">// （2）SHUTDOWN状态，队列不为空</span>

        <span class="token comment">// 获取工作线程数</span>
        <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// timed 是允许工作线程超时的标志位</span>
        <span class="token comment">// allowCoreThreadTimeOut 为true，表示所有线程均可中断</span>
        <span class="token comment">// allowCoreThreadTimeOut 为false，判断当前工作线程数 是否大于 核心线程数（要淘汰过量的线程）</span>
        <span class="token keyword">boolean</span> timed <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">||</span> wc <span class="token operator">&gt;</span> corePoolSize<span class="token punctuation">;</span>

        <span class="token comment">// (工作线程数大于最大线程数 || 有线程获取任务超时了) &amp;&amp; (工作线程数 &gt; 1 || 队列为空)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wc <span class="token operator">&gt;</span> maximumPoolSize <span class="token operator">||</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> timedOut<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 减小数量</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndDecrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 根据 timed的状态，采取不同的获取任务的方式</span>
            <span class="token comment">// （1）timed 为 true，当前有线程可以中断。采用 poll()阻塞一定时长的方式获取任务</span>
            <span class="token class-name">Runnable</span> r <span class="token operator">=</span> timed <span class="token operator">?</span>
                workQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">)</span> <span class="token operator">:</span>
            <span class="token comment">// （2）timed 为 false，当前没有线程可以中断。采用take()阻塞的方式直到获取到任务</span>
                workQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> r<span class="token punctuation">;</span>
            <span class="token comment">// 采用poll的方式还是获取不到任务，标志位设置为超时，下一次循环时淘汰该线程</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> retry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 捕获到中断异常，那就不需要线程池来处理了</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="处理worker退出"><a href="#处理worker退出" class="header-anchor">#</a> 处理Worker退出</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processWorkerExit</span><span class="token punctuation">(</span><span class="token class-name">Worker</span> w<span class="token punctuation">,</span> <span class="token keyword">boolean</span> completedAbruptly<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 线程执行用户业务时发生异常，直接跳到 finally {} 块</span>
    <span class="token comment">// 其他：获取不到任务的线程会由于超时，completedAbruptly会被更新为false，最后退出</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>completedAbruptly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 减少Worker数量</span>
        <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
        
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
    mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 计算总任务完成数</span>
        completedTaskCount <span class="token operator">+=</span> w<span class="token punctuation">.</span>completedTasks<span class="token punctuation">;</span>
        <span class="token comment">// 移除该Worker</span>
        workers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 小于 STOP状态 （SHUTDOWN状态和RUNNING状态，只有这两种状态可补充Worker）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateLessThan</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> STOP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 由于拿不到任务而退出</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>completedAbruptly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 计算池中线程数最小数量</span>
            <span class="token keyword">int</span> min <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> corePoolSize<span class="token punctuation">;</span>
            <span class="token comment">// 最小可为0 并且队列不为空</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>min <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 最小需要一个线程</span>
                min <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果当前工作线程数量 大于等于最新值，直接返回，不需要补充Worker</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> min<span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// replacement not needed</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 线程异常退出，或者线程不够用，那么补充Worker</span>
        <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="尝试终止线程池"><a href="#尝试终止线程池" class="header-anchor">#</a> 尝试终止线程池</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 以下为三种不需要中止的情况</span>
        <span class="token comment">// （1）线程池的状态为 RUNNING状态（线程池还处在运行状态，不能进行终止，直接返回）</span>
        <span class="token comment">// （2）线程池的状态至少为 TIDYING状态（也就是TIDYING状态和TERMINATED状态），已经进入了线程池终止尾声了，不需要重复终止</span>
        <span class="token comment">// （3）线程池的状态为 SHUTDOWN状态，队列不为空（SHUTDOWN状态，不能接收新任务，但需要继续处理阻塞队列中的任务，因此不能终止，直接返回）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> TIDYING<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 能够进入到这里的只有 SHUTDOWN状态（任务处理完，所以队列为空）和STOP状态（任务被抛弃，所以队列为空）</span>
        <span class="token comment">// 剩下的工作为清空工作线程</span>

        <span class="token comment">// 工作线程数量不为0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Eligible to terminate</span>
            <span class="token comment">// 只中断一个空闲的工作线程</span>
            <span class="token function">interruptIdleWorkers</span><span class="token punctuation">(</span>ONLY_ONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 加锁</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
        mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 通过CAS更新ctl值成功（运行状态为TIDYING，工作线程数为0）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token function">ctlOf</span><span class="token punctuation">(</span>TIDYING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 空实现，为一个钩子函数</span>
                    <span class="token function">terminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 通过CAS更新ctl值成功（运行状态为TERMINATED，工作线程数为0）</span>
                    ctl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span>TERMINATED<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    termination<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// else retry on failed CAS</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">3/31/2021, 11:09:45 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/main/笔记/线程/02_线程池.html" class="prev">线程池</a></span> <span class="next"><a href="/main/笔记/线程/03_异步.html">异步</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.132ddbf7.js" defer></script><script src="/assets/js/2.5c2f89f7.js" defer></script><script src="/assets/js/157.381cd390.js" defer></script>
  </body>
</html>
